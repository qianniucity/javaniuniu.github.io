I"ª*<p><strong>é»˜è®¤å®ç°SimpleGrantedAuthority</strong></p>
<h4 id="grantedauthorityæ¥å£">GrantedAuthorityæ¥å£</h4>
<p>æˆ‘ä»¬çŸ¥é“UserDeitailsæ¥å£é‡Œé¢æœ‰ä¸€ä¸ªgetAuthorities()æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•å°†è¿”å›æ­¤ç”¨æˆ·çš„æ‰€æ‹¥æœ‰çš„æƒé™ã€‚è¿™ä¸ªé›†åˆå°†ç”¨äºç”¨æˆ·çš„è®¿é—®æ§åˆ¶ï¼Œä¹Ÿå°±æ˜¯Authorizationã€‚</p>

<p>æ‰€è°“æƒé™ï¼Œå°±æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚ä¸€èˆ¬ä¸ä¼šé‡å¤ã€‚</p>

<p>æ‰€è°“æƒé™æ£€æŸ¥ï¼Œå°±æ˜¯æŸ¥çœ‹ç”¨æˆ·æƒé™åˆ—è¡¨ä¸­æ˜¯å¦å«æœ‰åŒ¹é…çš„å­—ç¬¦ä¸²ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">core</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">GrantedAuthority</span> <span class="kd">extends</span> <span class="nc">Serializable</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="nf">getAuthority</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>
<h4 id="è§’è‰²å¦‚ä½•è¡¨ç¤ºä¸shiroæœ‰ä½•ä¸åŒ">â€œè§’è‰²â€å¦‚ä½•è¡¨ç¤ºï¼Ÿä¸Shiroæœ‰ä½•ä¸åŒï¼Ÿ</h4>

<p>åœ¨Securityä¸­ï¼Œ<code class="highlighter-rouge">è§’è‰²å’Œæƒé™å…±ç”¨GrantedAuthorityæ¥å£</code>ï¼Œå”¯ä¸€çš„ä¸åŒè§’è‰²å°±æ˜¯å¤šäº†ä¸ªå‰ç¼€â€ROLE_â€œï¼Œè€Œä¸”<code class="highlighter-rouge">å®ƒæ²¡æœ‰Shiroçš„é‚£ç§ä»å±å…³ç³»</code>ï¼Œå³ä¸€ä¸ªè§’è‰²åŒ…å«å“ªäº›æƒé™ç­‰ç­‰ã€‚åœ¨Securityçœ‹æ¥è§’è‰²å’Œæƒé™æ—¶ä¸€æ ·çš„ï¼Œå®ƒè®¤è¯çš„æ—¶å€™ï¼ŒæŠŠæ‰€æœ‰æƒé™ï¼ˆè§’è‰²ã€æƒé™ï¼‰éƒ½å–å‡ºæ¥ï¼Œè€Œä¸æ˜¯åˆ†å¼€éªŒè¯ã€‚</p>

<p>æ‰€ä»¥ï¼Œåœ¨Securityæä¾›çš„UserDetailsServiceé»˜è®¤å®ç°JdbcDaoImplä¸­ï¼Œ<code class="highlighter-rouge">è§’è‰²å’Œæƒé™éƒ½å­˜å‚¨åœ¨auhtoritiesè¡¨ä¸­</code>ã€‚è€Œä¸æ˜¯åƒShiroé‚£æ ·ï¼Œè§’è‰²æœ‰ä¸ªrolesè¡¨ï¼Œæƒé™æœ‰ä¸ªpermissionsè¡¨ã€‚ä»¥åŠç›¸å…³çš„ç®¡ç†è¡¨ç­‰ç­‰ã€‚</p>

<p><strong>GrantedAuthorityæ¥å£çš„é»˜è®¤å®ç°SimpleGrantedAuthority</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">authority</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.security.core.GrantedAuthority</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.util.Assert</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">SimpleGrantedAuthority</span> <span class="kd">implements</span> <span class="nc">GrantedAuthority</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">500L</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">role</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">SimpleGrantedAuthority</span><span class="o">(</span><span class="nc">String</span> <span class="n">role</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Assert</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="n">role</span><span class="o">,</span> <span class="s">"A granted authority textual representation is required"</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">role</span> <span class="o">=</span> <span class="n">role</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getAuthority</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">role</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="nc">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">obj</span> <span class="k">instanceof</span> <span class="nc">SimpleGrantedAuthority</span> <span class="o">?</span> <span class="k">this</span><span class="o">.</span><span class="na">role</span><span class="o">.</span><span class="na">equals</span><span class="o">(((</span><span class="nc">SimpleGrantedAuthority</span><span class="o">)</span><span class="n">obj</span><span class="o">).</span><span class="na">role</span><span class="o">)</span> <span class="o">:</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">role</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">role</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>æ³¨æ„ï¼Œåœ¨æ„å»ºSimpleGrantedAuthorityå¯¹è±¡çš„æ—¶å€™ï¼Œå®ƒæ²¡æœ‰æ·»åŠ ä»»ä½•å‰ç¼€ã€‚æ‰€ä»¥è¡¨ç¤ºâ€è§’è‰²â€çš„æƒé™ï¼Œåœ¨æ•°æ®åº“ä¸­å°±å¸¦æœ‰â€ROLE_â€œå‰ç¼€äº†ã€‚æ‰€ä»¥authoritiesè¡¨ä¸­çš„è§†å›¾å¯èƒ½æ˜¯è¿™æ ·çš„ã€‚</p>

<p><img src="/assets/images/SpringSecurity/1313132-20190119134521755-1100857786.png" alt="å›¾ç‰‡pic1" /></p>

<p><strong>è§’è‰²å’Œæƒé™èƒ½å¦åˆ†å¼€å­˜å‚¨ï¼Ÿè§’è‰²èƒ½ä¸èƒ½ä¸å¸¦â€ROLE_â€œå‰ç¼€</strong></p>

<p>å½“ç„¶å¯ä»¥åˆ†å¼€å­˜å‚¨ï¼Œä½ å¯ä»¥å®šä¹‰ä¸¤å¼ è¡¨ï¼Œä¸€å¼ å­˜è§’è‰²ï¼Œä¸€å¼ å­˜æƒé™ã€‚ä½†æ˜¯ä½ è‡ªå®šä¹‰UserDetailsServiceçš„æ—¶å€™ï¼Œéœ€è¦ä¿è¯æŠŠè¿™ä¸¤å¼ è¡¨çš„æ•°æ®éƒ½å–å‡ºæ¥ï¼Œæ”¾åˆ°UserDailsçš„æƒé™é›†åˆä¸­ã€‚å½“ç„¶ä½ æ•°æ®åº“ä¸­å­˜å‚¨çš„è§’è‰²ä¹Ÿå¯ä»¥ä¸å¸¦â€ROLE_â€œå‰ç¼€ï¼Œå°±åƒè¿™æ ·ã€‚</p>

<p><img src="/assets/images/SpringSecurity/1313132-20190119133239244-1352677896.png" alt="å›¾ç‰‡pic2" />
<img src="/assets/images/SpringSecurity/1313132-20190119133256601-1567591650.png" alt="å›¾ç‰‡pic3" /></p>

<p>ä½†æ˜¯å‰é¢è¯´åˆ°äº†ï¼Œ<code class="highlighter-rouge">Securityæ‰ä¸ç®¡ä½ æ˜¯è§’è‰²ï¼Œè¿˜æ˜¯æƒé™ã€‚å®ƒåªæ¯”å¯¹å­—ç¬¦ä¸²ã€‚</code></p>

<p>æ¯”å¦‚å®ƒæœ‰ä¸ªè¡¨è¾¾å¼hasRole(â€œADMINâ€)ã€‚é‚£å®ƒå®é™…ä¸ŠæŸ¥è¯¢çš„æ˜¯ç”¨æˆ·æƒé™é›†åˆä¸­æ˜¯å¦å­˜åœ¨å­—ç¬¦ä¸²â€ROLE_ADMINâ€ã€‚å¦‚æœä½ ä»è§’è‰²è¡¨ä¸­å–å‡ºç”¨æˆ·æ‰€æ‹¥æœ‰çš„è§’è‰²æ—¶ä¸åŠ ä¸Šâ€ROLE_â€œå‰ç¼€ï¼Œé‚£éªŒè¯çš„æ—¶å€™å°±åŒ¹é…ä¸ä¸Šäº†ã€‚</p>

<p><code class="highlighter-rouge">æ‰€ä»¥è§’è‰²ä¿¡æ¯å­˜å‚¨çš„æ—¶å€™å¯ä»¥æ²¡æœ‰"ROLE_"å‰ç¼€ï¼Œä½†æ˜¯åŒ…è£…æˆGrantedAuthorityå¯¹è±¡çš„æ—¶å€™å¿…é¡»è¦æœ‰ã€‚</code></p>

<h4 id="æƒé™æ£€æŸ¥è®¿é—®æ§åˆ¶æ–¹å¼">æƒé™æ£€æŸ¥/è®¿é—®æ§åˆ¶æ–¹å¼</h4>

<p>æƒé™æ£€æŸ¥æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯åœ¨é…ç½®ç±»ä¸­ï¼ŒæŒ‡å®šç²—ç²’åº¦çš„è®¿é—®æ§åˆ¶ï¼Œå¦ä¸€ç§æ˜¯ä½¿ç”¨æ³¨è§£ç»†ç²’åº¦çš„æ§åˆ¶è®¿é—®ã€‚</p>

<p><strong>ç²—ç²’åº¦è®¿é—®æ§åˆ¶</strong>ï¼Œæ‰€æœ‰URLä»¥â€/adminâ€å¼€å¤´çš„ç”¨æˆ·å¿…é¡»æ‹¥æœ‰è§’è‰²â€ADMINâ€æ‰èƒ½è®¿é—®ã€‚å®é™…ä¸Šæ“ä½œçš„æ—¶å€™hasRoleè¡¨è¾¾å¼ï¼Œä¼šåˆ¤æ–­å‚æ•°æ˜¯å¦åŒ…å«â€ROLE_â€œå‰ç¼€ï¼Œå¦‚æœæ²¡æœ‰åˆ™åŠ ä¸Šå»ï¼Œç„¶åå†å»æ ¡éªŒã€‚æœ‰è¿™ä¸ªå‰ç¼€åˆ™ç›´æ¥æ ¡éªŒã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/admin/**"</span><span class="o">).</span><span class="na">access</span><span class="o">(</span><span class="s">"hasRole('ADMIN')"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/user/**"</span><span class="o">).</span><span class="na">access</span><span class="o">(</span><span class="s">"hasRole('USER')"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">();</span>

<span class="o">}</span>
</code></pre></div></div>
<p><strong>ç»†ç²’åº¦çš„è®¿é—®æ§åˆ¶</strong></p>

<p><code class="highlighter-rouge">æ³¨ï¼šéœ€è¦ä½¿ç”¨æ³¨è§£@EnableGlobalMethodSecurity(prePostEnabled=true) å¼€å¯</code></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@PreAuthoritze</span><span class="o">(</span><span class="s">"hasAuthority('readArtical')"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Artical</span><span class="o">&gt;</span> <span class="nf">getAll</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">//...</span>
<span class="o">}</span>
</code></pre></div></div>
<p>è¿™ä¸ªæ³¨è§£ï¼Œä¼šä»SecurityContextä¸­å–å‡ºAuthencationå¯¹è±¡ï¼Œç„¶åå†å–å‡ºCollection<GrantedAuthority> authoritesé›†åˆã€‚ç„¶åæ¯”å¯¹å½“å‰ç”¨æˆ·æ˜¯å¦æœ‰æƒé™"readArtical"ã€‚å®é™…ä¸Šå°±æ˜¯æ¯”å¯¹é›†åˆä¸­æ˜¯å¦æœ‰é‚£ä¸ªGrantedAuthorityçš„getAuthority()æ–¹æ³•è¿”å›çš„å­—ç¬¦ä¸²ä¸"radArtical"åŒ¹é…ã€‚</GrantedAuthority></p>
:ET