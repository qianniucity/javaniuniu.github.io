I"'<h2 id="ç®€ä»‹">ç®€ä»‹</h2>
<p>è‡ªå®šä¹‰è§£æå™¨éœ€è¦å®ç° <em>HandlerMethodArgumentResolver</em> æ¥å£ï¼Œ <em>HandlerMethodArgumentResolver</em> æ¥å£åŒ…å«ä¸¤ä¸ªæ¥å£å‡½æ•°ï¼š</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">HandlerMethodArgumentResolver</span> <span class="o">{</span>
    <span class="kt">boolean</span> <span class="nf">supportsParameter</span><span class="o">(</span><span class="nc">MethodParameter</span> <span class="n">var1</span><span class="o">);</span>

    <span class="nd">@Nullable</span>
    <span class="nc">Object</span> <span class="nf">resolveArgument</span><span class="o">(</span><span class="nc">MethodParameter</span> <span class="n">var1</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">ModelAndViewContainer</span> <span class="n">var2</span><span class="o">,</span> <span class="nc">NativeWebRequest</span> <span class="n">var3</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">WebDataBinderFactory</span> <span class="n">var4</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="è‡ªå®šä¹‰ä¸€ä¸ªè§£æå™¨currentusermethodargumentresolver">è‡ªå®šä¹‰ä¸€ä¸ªè§£æå™¨CurrentUserMethodArgumentResolver</h2>

<p>æˆ‘ä»¬åœ¨è§£æå™¨ä¸­è¿”å›ä¸€ä¸ªå›ºå®šçš„ <em>UserBeannew UserBean(1L,â€adminâ€)</em> ï¼Œå®é™…æƒ…å†µæ˜¯ä»Sessionã€æ•°æ®åº“æˆ–è€…ç¼“å­˜ä¸­æŸ¥ã€‚</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.core.MethodParameter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.support.WebDataBinderFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.context.request.NativeWebRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.method.support.HandlerMethodArgumentResolver</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.method.support.ModelAndViewContainer</span><span class="o">;</span>

<span class="cm">/**
 * ç”¨äºç»‘å®š@CurrentUserçš„æ–¹æ³•å‚æ•°è§£æå™¨
 *
 * @author lism
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CurrentUserMethodArgumentResolver</span> <span class="kd">implements</span> <span class="nc">HandlerMethodArgumentResolver</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">CurrentUserMethodArgumentResolver</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">supportsParameter</span><span class="o">(</span><span class="nc">MethodParameter</span> <span class="n">parameter</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">parameter</span><span class="o">.</span><span class="na">getParameterType</span><span class="o">().</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="nc">UserBean</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">parameter</span><span class="o">.</span><span class="na">hasParameterAnnotation</span><span class="o">(</span><span class="nc">CurrentUser</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">resolveArgument</span><span class="o">(</span><span class="nc">MethodParameter</span> <span class="n">parameter</span><span class="o">,</span> <span class="nc">ModelAndViewContainer</span> <span class="n">mavContainer</span><span class="o">,</span> <span class="nc">NativeWebRequest</span> <span class="n">webRequest</span><span class="o">,</span> <span class="nc">WebDataBinderFactory</span> <span class="n">binderFactory</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">CurrentUser</span> <span class="n">currentUserAnnotation</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="na">getParameterAnnotation</span><span class="o">(</span><span class="nc">CurrentUser</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="c1">//ä»Session è·å–ç”¨æˆ·</span>
        <span class="nc">Object</span> <span class="n">object</span> <span class="o">=</span> <span class="n">webRequest</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">currentUserAnnotation</span><span class="o">.</span><span class="na">value</span><span class="o">(),</span> <span class="nc">NativeWebRequest</span><span class="o">.</span><span class="na">SCOPE_SESSION</span><span class="o">);</span>
<span class="c1">//ä»  accessTokenè·å¾—ç”¨æˆ·ä¿¡æ¯</span>
       <span class="k">if</span> <span class="o">(</span><span class="n">object</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">webRequest</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">"Authorization"</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">token</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">webRequest</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"accessToken"</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="c1">//ä¸ºäº†æµ‹è¯•å…ˆå†™æ­»ç”¨æˆ·å</span>
            <span class="c1">//TODO: å–çœŸå®ç”¨æˆ·</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">UserBean</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span><span class="s">"admin"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">object</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="è‡ªå®šä¹‰æ³¨è§£currentuser">è‡ªå®šä¹‰æ³¨è§£@CurrentUser</h2>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.lang.annotation.*</span><span class="o">;</span>

<span class="cm">/**
 * &lt;p&gt;ç»‘å®šå½“å‰ç™»å½•çš„ç”¨æˆ·&lt;/p&gt;
 * &lt;p&gt;ä¸åŒäº@ModelAttribute&lt;/p&gt;
 *
 * @author lism
 */</span>
<span class="nd">@Target</span><span class="o">({</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">PARAMETER</span><span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Documented</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">CurrentUser</span> <span class="o">{</span>

    <span class="cm">/**
     * å½“å‰ç”¨æˆ·åœ¨requestä¸­çš„åå­—
     *
     * @return
     */</span>
    <span class="nc">String</span> <span class="nf">value</span><span class="o">()</span> <span class="k">default</span> <span class="s">"user"</span><span class="o">;</span>

<span class="o">}</span>
</code></pre></div></div>

<h2 id="åœ¨æ§åˆ¶å™¨ä¸­ä½¿ç”¨currentuser">åœ¨æ§åˆ¶å™¨ä¸­ä½¿ç”¨@CurrentUser</h2>

<p>åœ¨æ§åˆ¶å™¨æ–¹æ³•ä¸ŠåŠ å…¥ <em>@CurrentUser UserBean userBean</em> å³å¯è‡ªåŠ¨æ³¨å…¥userBeançš„å€¼</p>

<p>@RestController
@RequestMapping(value = â€œ/testâ€)
public class TestController  {</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/**
 * æ ¹æ®nameæŸ¥è¯¢
 *
 * @param request
 * @return
 */
@RequestMapping(value = "/testCurrentUser", method = RequestMethod.POST, produces = "application/json", consumes = "application/json")
@ResponseBody
public void test(@CurrentUser UserBean userBean, @RequestBody SubjectRequest request) {
    String createdBy = userBean.getUsername();
    log.info(createdBy);
} } Userå®ä½“UserBean
</code></pre></div></div>

<p>import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;</p>

<p>import java.io.Serializable;</p>

<p>@Data
@NoArgsConstructor
@AllArgsConstructor
public class UserBean implements Serializable {
    private Long id;
    private String username;
}
æ€»ç»“</p>

<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡å®ç°HandlerMethodArgumentResolveræ¥å£æ¥å®ç°å¯¹è‡ªå®šä¹‰çš„å‚æ•°è¿›è¡Œè§£æã€‚
æ¯”å¦‚å¯ä»¥è§£æè‡ªå®šä¹‰çš„æ—¶é—´æ ¼å¼ã€è‡ªå®šä¹‰è§£æMapå¯¹è±¡ç­‰è¿™äº›springåŸæœ¬ä¸æ”¯æŒçš„å¯¹è±¡æ ¼å¼ã€‚</p>

<p>ä½œè€…ï¼šLIæœ¨æ°´
é“¾æ¥ï¼šhttps://www.jianshu.com/p/40606baf49b8
æ¥æºï¼šç®€ä¹¦
è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>
:ET