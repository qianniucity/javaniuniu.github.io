I"Áz<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Redisåˆ†å¸ƒå¼é”
 * ä½¿ç”¨ SET resource-name anystring NX EX max-lock-time å®ç°
 * &lt;p&gt;
 * è¯¥æ–¹æ¡ˆåœ¨ Redis å®˜æ–¹ SET å‘½ä»¤é¡µæœ‰è¯¦ç»†ä»‹ç»ã€‚
 * http://doc.redisfans.com/string/set.html
 * &lt;p&gt;
 * åœ¨ä»‹ç»è¯¥åˆ†å¸ƒå¼é”è®¾è®¡ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹åœ¨ä» Redis 2.6.12 å¼€å§‹ SET æä¾›çš„æ–°ç‰¹æ€§ï¼Œ
 * å‘½ä»¤ SET key value [EX seconds] [PX milliseconds] [NX|XX]ï¼Œå…¶ä¸­ï¼š
 * &lt;p&gt;
 * EX seconds â€” ä»¥ç§’ä¸ºå•ä½è®¾ç½® key çš„è¿‡æœŸæ—¶é—´ï¼›
 * PX milliseconds â€” ä»¥æ¯«ç§’ä¸ºå•ä½è®¾ç½® key çš„è¿‡æœŸæ—¶é—´ï¼›
 * NX â€” å°†key çš„å€¼è®¾ä¸ºvalue ï¼Œå½“ä¸”ä»…å½“key ä¸å­˜åœ¨ï¼Œç­‰æ•ˆäº SETNXã€‚
 * XX â€” å°†key çš„å€¼è®¾ä¸ºvalue ï¼Œå½“ä¸”ä»…å½“key å­˜åœ¨ï¼Œç­‰æ•ˆäº SETEXã€‚
 * &lt;p&gt;
 * å‘½ä»¤ SET resource-name anystring NX EX max-lock-time æ˜¯ä¸€ç§åœ¨ Redis ä¸­å®ç°é”çš„ç®€å•æ–¹æ³•ã€‚
 * &lt;p&gt;
 * å®¢æˆ·ç«¯æ‰§è¡Œä»¥ä¸Šçš„å‘½ä»¤ï¼š
 * &lt;p&gt;
 * å¦‚æœæœåŠ¡å™¨è¿”å› OK ï¼Œé‚£ä¹ˆè¿™ä¸ªå®¢æˆ·ç«¯è·å¾—é”ã€‚
 * å¦‚æœæœåŠ¡å™¨è¿”å› NIL ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯è·å–é”å¤±è´¥ï¼Œå¯ä»¥åœ¨ç¨åå†é‡è¯•ã€‚
 *
 * @author zsy
 * @version 1.0
 * @date 2019å¹´8æœˆ22æ—¥ 22:21:27
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisLock</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">RedisLock</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="kd">private</span> <span class="nc">RedisTemplate</span> <span class="n">redisTemplate</span><span class="o">;</span>

    <span class="cm">/**
     * å°†key çš„å€¼è®¾ä¸ºvalue ï¼Œå½“ä¸”ä»…å½“key ä¸å­˜åœ¨ï¼Œç­‰æ•ˆäº SETNXã€‚
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">NX</span> <span class="o">=</span> <span class="s">"NX"</span><span class="o">;</span>

    <span class="cm">/**
     * seconds â€” ä»¥ç§’ä¸ºå•ä½è®¾ç½® key çš„è¿‡æœŸæ—¶é—´ï¼Œç­‰æ•ˆäºEXPIRE key seconds
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">EX</span> <span class="o">=</span> <span class="s">"EX"</span><span class="o">;</span>

    <span class="cm">/**
     * è°ƒç”¨setåçš„è¿”å›å€¼
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">OK</span> <span class="o">=</span> <span class="s">"OK"</span><span class="o">;</span>

    <span class="cm">/**
     * é»˜è®¤è¯·æ±‚é”çš„è¶…æ—¶æ—¶é—´(ms æ¯«ç§’)
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="no">TIME_OUT</span> <span class="o">=</span> <span class="mi">100</span><span class="o">;</span>

    <span class="cm">/**
     * é»˜è®¤é”çš„æœ‰æ•ˆæ—¶é—´(s)
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">EXPIRE</span> <span class="o">=</span> <span class="mi">60</span><span class="o">;</span>

    <span class="cm">/**
     * è§£é”çš„luaè„šæœ¬
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">UNLOCK_LUA</span><span class="o">;</span>

    <span class="kd">static</span> <span class="o">{</span>
        <span class="nc">StringBuilder</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
        <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"if redis.call(\"get\",KEYS[1]) == ARGV[1] "</span><span class="o">);</span>
        <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"then "</span><span class="o">);</span>
        <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"    return redis.call(\"del\",KEYS[1]) "</span><span class="o">);</span>
        <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"else "</span><span class="o">);</span>
        <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"    return 0 "</span><span class="o">);</span>
        <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"end "</span><span class="o">);</span>
        <span class="no">UNLOCK_LUA</span> <span class="o">=</span> <span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * é”æ ‡å¿—å¯¹åº”çš„key
     */</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">lockKey</span><span class="o">;</span>

    <span class="cm">/**
     * è®°å½•åˆ°æ—¥å¿—çš„é”æ ‡å¿—å¯¹åº”çš„key
     */</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">lockKeyLog</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>

    <span class="cm">/**
     * é”å¯¹åº”çš„å€¼
     */</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">lockValue</span><span class="o">;</span>

    <span class="cm">/**
     * é”çš„æœ‰æ•ˆæ—¶é—´(s)
     */</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">expireTime</span> <span class="o">=</span> <span class="no">EXPIRE</span><span class="o">;</span>

    <span class="cm">/**
     * è¯·æ±‚é”çš„è¶…æ—¶æ—¶é—´(ms)
     */</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">timeOut</span> <span class="o">=</span> <span class="no">TIME_OUT</span><span class="o">;</span>

    <span class="cm">/**
     * é”æ ‡è®°
     */</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">locked</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

    <span class="kd">final</span> <span class="nc">Random</span> <span class="n">random</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">();</span>

    <span class="cm">/**
     * ä½¿ç”¨é»˜è®¤çš„é”è¿‡æœŸæ—¶é—´å’Œè¯·æ±‚é”çš„è¶…æ—¶æ—¶é—´
     *
     * @param redisTemplate
     * @param lockKey       é”çš„keyï¼ˆRedisçš„Keyï¼‰
     */</span>
    <span class="kd">public</span> <span class="nf">RedisLock</span><span class="o">(</span><span class="nc">RedisTemplate</span> <span class="n">redisTemplate</span><span class="o">,</span> <span class="nc">String</span> <span class="n">lockKey</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">redisTemplate</span> <span class="o">=</span> <span class="n">redisTemplate</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">lockKey</span> <span class="o">=</span> <span class="n">lockKey</span> <span class="o">+</span> <span class="s">"_lock"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * ä½¿ç”¨é»˜è®¤çš„è¯·æ±‚é”çš„è¶…æ—¶æ—¶é—´ï¼ŒæŒ‡å®šé”çš„è¿‡æœŸæ—¶é—´
     *
     * @param redisTemplate
     * @param lockKey       é”çš„keyï¼ˆRedisçš„Keyï¼‰
     * @param expireTime    é”çš„è¿‡æœŸæ—¶é—´(å•ä½ï¼šç§’)
     */</span>
    <span class="kd">public</span> <span class="nf">RedisLock</span><span class="o">(</span><span class="nc">RedisTemplate</span> <span class="n">redisTemplate</span><span class="o">,</span> <span class="nc">String</span> <span class="n">lockKey</span><span class="o">,</span> <span class="kt">int</span> <span class="n">expireTime</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">(</span><span class="n">redisTemplate</span><span class="o">,</span> <span class="n">lockKey</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">expireTime</span> <span class="o">=</span> <span class="n">expireTime</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * ä½¿ç”¨é»˜è®¤çš„é”çš„è¿‡æœŸæ—¶é—´ï¼ŒæŒ‡å®šè¯·æ±‚é”çš„è¶…æ—¶æ—¶é—´
     *
     * @param redisTemplate
     * @param lockKey       é”çš„keyï¼ˆRedisçš„Keyï¼‰
     * @param timeOut       è¯·æ±‚é”çš„è¶…æ—¶æ—¶é—´(å•ä½ï¼šæ¯«ç§’)
     */</span>
    <span class="kd">public</span> <span class="nf">RedisLock</span><span class="o">(</span><span class="nc">RedisTemplate</span> <span class="n">redisTemplate</span><span class="o">,</span> <span class="nc">String</span> <span class="n">lockKey</span><span class="o">,</span> <span class="kt">long</span> <span class="n">timeOut</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">(</span><span class="n">redisTemplate</span><span class="o">,</span> <span class="n">lockKey</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">timeOut</span> <span class="o">=</span> <span class="n">timeOut</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * é”çš„è¿‡æœŸæ—¶é—´å’Œè¯·æ±‚é”çš„è¶…æ—¶æ—¶é—´éƒ½æ˜¯ç”¨æŒ‡å®šçš„å€¼
     *
     * @param redisTemplate
     * @param lockKey       é”çš„keyï¼ˆRedisçš„Keyï¼‰
     * @param expireTime    é”çš„è¿‡æœŸæ—¶é—´(å•ä½ï¼šç§’)
     * @param timeOut       è¯·æ±‚é”çš„è¶…æ—¶æ—¶é—´(å•ä½ï¼šæ¯«ç§’)
     */</span>
    <span class="kd">public</span> <span class="nf">RedisLock</span><span class="o">(</span><span class="nc">RedisTemplate</span> <span class="n">redisTemplate</span><span class="o">,</span> <span class="nc">String</span> <span class="n">lockKey</span><span class="o">,</span> <span class="kt">int</span> <span class="n">expireTime</span><span class="o">,</span> <span class="kt">long</span> <span class="n">timeOut</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">(</span><span class="n">redisTemplate</span><span class="o">,</span> <span class="n">lockKey</span><span class="o">,</span> <span class="n">expireTime</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">timeOut</span> <span class="o">=</span> <span class="n">timeOut</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * å°è¯•è·å–é” è¶…æ—¶è¿”å›
     *
     * @return
     */</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">tryLock</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// ç”Ÿæˆéšæœºkey</span>
        <span class="n">lockValue</span> <span class="o">=</span> <span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
        <span class="c1">// è¯·æ±‚é”è¶…æ—¶æ—¶é—´ï¼Œçº³ç§’</span>
        <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">timeOut</span> <span class="o">*</span> <span class="mi">1000000</span><span class="o">;</span>
        <span class="c1">// ç³»ç»Ÿå½“å‰æ—¶é—´ï¼Œçº³ç§’</span>
        <span class="kt">long</span> <span class="n">nowTime</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">((</span><span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()</span> <span class="o">-</span> <span class="n">nowTime</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="no">OK</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">lockKey</span><span class="o">,</span> <span class="n">lockValue</span><span class="o">,</span> <span class="n">expireTime</span><span class="o">)))</span> <span class="o">{</span>
                <span class="n">locked</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="c1">// ä¸Šé”æˆåŠŸç»“æŸè¯·æ±‚</span>
                <span class="k">return</span> <span class="n">locked</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="c1">// æ¯æ¬¡è¯·æ±‚ç­‰å¾…ä¸€æ®µæ—¶é—´</span>
            <span class="n">seleep</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="mi">50000</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">locked</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * å°è¯•è·å–é” ç«‹å³è¿”å›
     *
     * @return æ˜¯å¦æˆåŠŸè·å¾—é”
     */</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">lock</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">lockValue</span> <span class="o">=</span> <span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
        <span class="c1">//ä¸å­˜åœ¨åˆ™æ·»åŠ  ä¸”è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆå•ä½msï¼‰</span>
        <span class="nc">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">set</span><span class="o">(</span><span class="n">lockKey</span><span class="o">,</span> <span class="n">lockValue</span><span class="o">,</span> <span class="n">expireTime</span><span class="o">);</span>
        <span class="n">locked</span> <span class="o">=</span> <span class="no">OK</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">locked</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * ä»¥é˜»å¡æ–¹å¼çš„è·å–é”
     *
     * @return æ˜¯å¦æˆåŠŸè·å¾—é”
     */</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">lockBlock</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">lockValue</span> <span class="o">=</span> <span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//ä¸å­˜åœ¨åˆ™æ·»åŠ  ä¸”è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆå•ä½msï¼‰</span>
            <span class="nc">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">set</span><span class="o">(</span><span class="n">lockKey</span><span class="o">,</span> <span class="n">lockValue</span><span class="o">,</span> <span class="n">expireTime</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="no">OK</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">result</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">locked</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="k">return</span> <span class="n">locked</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="c1">// æ¯æ¬¡è¯·æ±‚ç­‰å¾…ä¸€æ®µæ—¶é—´</span>
            <span class="n">seleep</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="mi">50000</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * è§£é”
     * &lt;p&gt;
     * å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¿®æ”¹ï¼Œè®©è¿™ä¸ªé”å®ç°æ›´å¥å£®ï¼š
     * &lt;p&gt;
     * ä¸ä½¿ç”¨å›ºå®šçš„å­—ç¬¦ä¸²ä½œä¸ºé”®çš„å€¼ï¼Œè€Œæ˜¯è®¾ç½®ä¸€ä¸ªä¸å¯çŒœæµ‹ï¼ˆnon-guessableï¼‰çš„é•¿éšæœºå­—ç¬¦ä¸²ï¼Œä½œä¸ºå£ä»¤ä¸²ï¼ˆtokenï¼‰ã€‚
     * ä¸ä½¿ç”¨ DEL å‘½ä»¤æ¥é‡Šæ”¾é”ï¼Œè€Œæ˜¯å‘é€ä¸€ä¸ª Lua è„šæœ¬ï¼Œè¿™ä¸ªè„šæœ¬åªåœ¨å®¢æˆ·ç«¯ä¼ å…¥çš„å€¼å’Œé”®çš„å£ä»¤ä¸²ç›¸åŒ¹é…æ—¶ï¼Œæ‰å¯¹é”®è¿›è¡Œåˆ é™¤ã€‚
     * è¿™ä¸¤ä¸ªæ”¹åŠ¨å¯ä»¥é˜²æ­¢æŒæœ‰è¿‡æœŸé”çš„å®¢æˆ·ç«¯è¯¯åˆ ç°æœ‰é”çš„æƒ…å†µå‡ºç°ã€‚
     */</span>
    <span class="kd">public</span> <span class="nc">Boolean</span> <span class="nf">unlock</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// åªæœ‰åŠ é”æˆåŠŸå¹¶ä¸”é”è¿˜æœ‰æ•ˆæ‰å»é‡Šæ”¾é”</span>
        <span class="c1">// åªæœ‰åŠ é”æˆåŠŸå¹¶ä¸”é”è¿˜æœ‰æ•ˆæ‰å»é‡Šæ”¾é”</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">locked</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">(</span><span class="nc">Boolean</span><span class="o">)</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="nc">RedisCallback</span><span class="o">&lt;</span><span class="nc">Boolean</span><span class="o">&gt;()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="nc">Boolean</span> <span class="nf">doInRedis</span><span class="o">(</span><span class="nc">RedisConnection</span> <span class="n">connection</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">DataAccessException</span> <span class="o">{</span>
                    <span class="nc">Object</span> <span class="n">nativeConnection</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">getNativeConnection</span><span class="o">();</span>
                    <span class="nc">Long</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0L</span><span class="o">;</span>

                    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">keys</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
                    <span class="n">keys</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">lockKey</span><span class="o">);</span>
                    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">values</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
                    <span class="n">values</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">lockValue</span><span class="o">);</span>

                    <span class="c1">// é›†ç¾¤æ¨¡å¼</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">nativeConnection</span> <span class="k">instanceof</span> <span class="nc">JedisCluster</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Long</span><span class="o">)</span> <span class="o">((</span><span class="nc">JedisCluster</span><span class="o">)</span> <span class="n">nativeConnection</span><span class="o">).</span><span class="na">eval</span><span class="o">(</span><span class="no">UNLOCK_LUA</span><span class="o">,</span> <span class="n">keys</span><span class="o">,</span> <span class="n">values</span><span class="o">);</span>
                    <span class="o">}</span>

                    <span class="c1">// å•æœºæ¨¡å¼</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">nativeConnection</span> <span class="k">instanceof</span> <span class="nc">Jedis</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Long</span><span class="o">)</span> <span class="o">((</span><span class="nc">Jedis</span><span class="o">)</span> <span class="n">nativeConnection</span><span class="o">).</span><span class="na">eval</span><span class="o">(</span><span class="no">UNLOCK_LUA</span><span class="o">,</span> <span class="n">keys</span><span class="o">,</span> <span class="n">values</span><span class="o">);</span>
                    <span class="o">}</span>

                    <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">lockKeyLog</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Redisåˆ†å¸ƒå¼é”ï¼Œè§£é”{}å¤±è´¥ï¼è§£é”æ—¶é—´ï¼š{}"</span><span class="o">,</span> <span class="n">lockKeyLog</span><span class="o">,</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>
                    <span class="o">}</span>

                    <span class="n">locked</span> <span class="o">=</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">0</span><span class="o">;</span>
                    <span class="k">return</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">1</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * é‡å†™redisTemplateçš„setæ–¹æ³•
     * &lt;p&gt;
     * å‘½ä»¤ SET resource-name anystring NX EX max-lock-time æ˜¯ä¸€ç§åœ¨ Redis ä¸­å®ç°é”çš„ç®€å•æ–¹æ³•ã€‚
     * &lt;p&gt;
     * å®¢æˆ·ç«¯æ‰§è¡Œä»¥ä¸Šçš„å‘½ä»¤ï¼š
     * &lt;p&gt;
     * å¦‚æœæœåŠ¡å™¨è¿”å› OK ï¼Œé‚£ä¹ˆè¿™ä¸ªå®¢æˆ·ç«¯è·å¾—é”ã€‚
     * å¦‚æœæœåŠ¡å™¨è¿”å› NIL ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯è·å–é”å¤±è´¥ï¼Œå¯ä»¥åœ¨ç¨åå†é‡è¯•ã€‚
     *
     * @param key     é”çš„Key
     * @param value   é”é‡Œé¢çš„å€¼
     * @param seconds è¿‡å»æ—¶é—´ï¼ˆç§’ï¼‰
     * @return
     */</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="nf">set</span><span class="o">(</span><span class="kd">final</span> <span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">value</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">seconds</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Assert</span><span class="o">.</span><span class="na">isTrue</span><span class="o">(!</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">key</span><span class="o">),</span> <span class="s">"keyä¸èƒ½ä¸ºç©º"</span><span class="o">);</span>
        <span class="k">return</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="nc">RedisCallback</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="nc">String</span> <span class="nf">doInRedis</span><span class="o">(</span><span class="nc">RedisConnection</span> <span class="n">connection</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">DataAccessException</span> <span class="o">{</span>
                <span class="nc">Object</span> <span class="n">nativeConnection</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">getNativeConnection</span><span class="o">();</span>
                <span class="nc">String</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">nativeConnection</span> <span class="k">instanceof</span> <span class="nc">JedisCommands</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="o">((</span><span class="nc">JedisCommands</span><span class="o">)</span> <span class="n">nativeConnection</span><span class="o">).</span><span class="na">set</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="no">NX</span><span class="o">,</span> <span class="no">EX</span><span class="o">,</span> <span class="n">seconds</span><span class="o">);</span>
                <span class="o">}</span>

                <span class="k">if</span> <span class="o">(!</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">lockKeyLog</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">result</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"è·å–é”{}çš„æ—¶é—´ï¼š{}"</span><span class="o">,</span> <span class="n">lockKeyLog</span><span class="o">,</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>
                <span class="o">}</span>

                <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>

    <span class="cm">/**
     * @param millis æ¯«ç§’
     * @param nanos  çº³ç§’
     * @Title: seleep
     * @Description: çº¿ç¨‹ç­‰å¾…æ—¶é—´
     * @author yuhao.wang
     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">seleep</span><span class="o">(</span><span class="kt">long</span> <span class="n">millis</span><span class="o">,</span> <span class="kt">int</span> <span class="n">nanos</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">millis</span><span class="o">,</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">nanos</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"è·å–åˆ†å¸ƒå¼é”ä¼‘çœ è¢«ä¸­æ–­ï¼š"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getLockKeyLog</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">lockKeyLog</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setLockKeyLog</span><span class="o">(</span><span class="nc">String</span> <span class="n">lockKeyLog</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">lockKeyLog</span> <span class="o">=</span> <span class="n">lockKeyLog</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getExpireTime</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">expireTime</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setExpireTime</span><span class="o">(</span><span class="kt">int</span> <span class="n">expireTime</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">expireTime</span> <span class="o">=</span> <span class="n">expireTime</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getTimeOut</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">timeOut</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTimeOut</span><span class="o">(</span><span class="kt">long</span> <span class="n">timeOut</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">timeOut</span> <span class="o">=</span> <span class="n">timeOut</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>


</code></pre></div></div>
:ET