I"±1<h5 id="ä¸€å¥è¯ç®€ä»‹">ä¸€å¥è¯ç®€ä»‹</h5>
<p>WebMvcConfigureré…ç½®ç±»å…¶å®æ˜¯Springå†…éƒ¨çš„ä¸€ç§é…ç½®æ–¹å¼ï¼Œé‡‡ç”¨JavaBeançš„å½¢å¼æ¥ä»£æ›¿ä¼ ç»Ÿçš„xmlé…ç½®æ–‡ä»¶å½¢å¼è¿›è¡Œé’ˆå¯¹æ¡†æ¶ä¸ªæ€§åŒ–å®šåˆ¶ï¼Œå¯ä»¥è‡ªå®šä¹‰ä¸€äº›Handlerï¼ŒInterceptorï¼ŒViewResolverï¼ŒMessageConverterã€‚åŸºäºjava-basedæ–¹å¼çš„spring mvcé…ç½®ï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªé…ç½®ç±»å¹¶å®ç°WebMvcConfigurer æ¥å£</p>

<h5 id="ä¸»è¦è®²è§£">ä¸»è¦è®²è§£</h5>
<p>é€šè¿‡ViewControllerå°†ä¸€ä¸ªè¯·æ±‚è½¬åˆ°ä¸€ä¸ªé¡µé¢
é€šè¿‡ResourceHandlerså®ç°é™æ€èµ„æºçš„åœ°å€æ˜ å°„
é€šè¿‡MessageConverterå®ç°å°†@ResponseBodyå®ä½“è½¬Fastjsonå­—ç¬¦ä¸²è¿”å›ï¼Œå¯ä»¥è¿”å›å®ä½“è¿›è¡Œé‡å†™
é€šè¿‡addCorsMappingså®ç°ajaxè·¨åŸŸè¯·æ±‚
é€šè¿‡addInterceptorsæ·»åŠ æ‹¦æˆªå™¨</p>

<p>SpringBoot2.0ï¼ˆå®˜æ–¹æ¨èï¼‰</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>    
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebMvcConfg</span> <span class="kd">implements</span> <span class="nc">WebMvcConfigurer</span> <span class="o">{</span>
<span class="o">}</span>
</code></pre></div></div>
<p>SpringBoot2.0ä»¥å‰ç‰ˆæœ¬</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>    
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebMvcConfig</span> <span class="kd">extends</span> <span class="nc">WebMvcConfigurerAdapter</span> <span class="o">{</span>
<span class="err">ï½</span>
</code></pre></div></div>

<h5 id="é…ç½®resourcehandlers">é…ç½®ResourceHandlers</h5>

<p>æ­¤æ–¹æ³•ç”¨æ¥ä¸“é—¨æ³¨å†Œä¸€ä¸ªHandlerï¼Œæ¥å¤„ç†é™æ€èµ„æºçš„ï¼Œä¾‹å¦‚ï¼šå›¾ç‰‡ï¼Œjsï¼Œcssç­‰ã€‚ä¸¾ä¾‹ï¼š</p>

<p>@Override
 public void addResourceHandlers(ResourceHandlerRegistry registry) {
     //å¯ä»¥é€šè¿‡http://127.0.0.1:8080/web/home.htmlè®¿é—®resources/web/home.htmlé¡µé¢
     registry.addResourceHandler(â€œ/web/**â€).addResourceLocations(â€œclasspath:/web/â€);
 }
1
2
3
4
5
å½“ä½ è¯·æ±‚http://127.0.0.1:8080/web/home.htmlæ—¶ï¼Œä¼šæŠŠresources/web/home.htmlè¿”å›ã€‚æ³¨æ„ï¼šè¿™é‡Œçš„é™æ€èµ„æºæ˜¯æ”¾ç½®åœ¨WEB-INFç›®å½•ä¸‹çš„</p>

<p>é…ç½®ViewController</p>

<p>æ­¤æ–¹æ³•å¯ä»¥å¾ˆæ–¹ä¾¿çš„å®ç°ä¸€ä¸ªè¯·æ±‚åˆ°è§†å›¾çš„æ˜ å°„ï¼Œè€Œæ— éœ€ä¹¦å†™controllerï¼Œä¾‹å¦‚ï¼š</p>

<p>@Override
public void addViewControllers(ViewControllerRegistry registry){
	registry.addViewController(â€œ/loginâ€).setViewName(â€œweb/login.htmlâ€);
}
1
2
3
4
è¿™æ˜¯è®¿é—®http://127.0.0.1:8080/loginæ—¶ï¼Œä¼šç›´æ¥è¿”å›login.htmlé¡µé¢ã€‚
é…ç½®MessageConverter</p>

<p>è¿™ä¸ªé…ç½®ä¸€èˆ¬é’ˆå¯¹äºApiæ¥å£æœåŠ¡ç¨‹åºï¼Œé…ç½®åœ¨è¯·æ±‚è¿”å›æ—¶å†…å®¹é‡‡ç”¨ä»€ä¹ˆè½¬æ¢å™¨è¿›è¡Œè½¬æ¢ï¼Œæˆ‘ä»¬æœ€å¸¸ç”¨åˆ°çš„å°±æ˜¯fastJsonçš„è½¬æ¢ï¼Œé…ç½®å¦‚ä¸‹æ‰€ç¤º</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/**
 * æ¶ˆæ¯å†…å®¹è½¬æ¢é…ç½®
 * é…ç½®fastJsonè¿”å›jsonè½¬æ¢
 * @param converters
 */
@Override
public void configureMessageConverters(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters) {
    //åˆ›å»ºfastJsonæ¶ˆæ¯è½¬æ¢å™¨
    FastJsonHttpMessageConverter fastConverter = new FastJsonHttpMessageConverter(){
        protected void writeInternal(Object obj, HttpOutputMessage outputMessage){
            try {
                if(obj instanceof PreUser){
                    Map&lt;String,Object&gt; map = new HashMap&lt;&gt;();
                    map.put("preUser",obj);
                    map.put("result","success");
                    super.writeInternal( map, outputMessage);
                }else{
                    super.writeInternal( obj, outputMessage);
                }
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
    };
  //  FastJsonHttpMessageConverter fastConverter = new FastJsonHttpMessageConverter();
    List&lt;MediaType&gt; supportedMediaTypes = new ArrayList&lt;&gt;();
    supportedMediaTypes.add(MediaType.APPLICATION_JSON);
    supportedMediaTypes.add(MediaType.APPLICATION_JSON_UTF8);
    fastConverter.setSupportedMediaTypes(supportedMediaTypes);

    //åˆ›å»ºé…ç½®ç±»
    FastJsonConfig fastJsonConfig = new FastJsonConfig();
    fastJsonConfig.setCharset(Charset.forName("UTF-8"));
    fastJsonConfig.setDateFormat("YYYY-MM-dd");

    //ä¿®æ”¹é…ç½®è¿”å›å†…å®¹çš„è¿‡æ»¤
    fastJsonConfig.setSerializerFeatures(
            SerializerFeature.DisableCircularReferenceDetect,
            SerializerFeature.WriteMapNullValue,
            SerializerFeature.WriteNullStringAsEmpty,
            SerializerFeature.PrettyFormat
    );
    fastConverter.setFastJsonConfig(fastJsonConfig);
    //å°†fastjsonæ·»åŠ åˆ°è§†å›¾æ¶ˆæ¯è½¬æ¢å™¨åˆ—è¡¨å†…
    converters.add(fastConverter);
} 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 FastJson SerializerFeatures WriteNullListAsEmpty ï¼šListå­—æ®µå¦‚æœä¸ºnull,è¾“å‡ºä¸º[],è€Œénull WriteNullStringAsEmpty ï¼š å­—ç¬¦ç±»å‹å­—æ®µå¦‚æœä¸ºnull,è¾“å‡ºä¸º"",è€Œénull DisableCircularReferenceDetect ï¼šæ¶ˆé™¤å¯¹åŒä¸€å¯¹è±¡å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼Œé»˜è®¤ä¸ºfalseï¼ˆå¦‚æœä¸é…ç½®æœ‰å¯èƒ½ä¼šè¿›å…¥æ­»å¾ªç¯ï¼‰ WriteNullBooleanAsFalseï¼šBooleanå­—æ®µå¦‚æœä¸ºnull,è¾“å‡ºä¸ºfalse,è€Œénull WriteMapNullValueï¼šæ˜¯å¦è¾“å‡ºå€¼ä¸ºnullçš„å­—æ®µ,é»˜è®¤ä¸ºfalseã€‚ WriteNullNumberAsZero: æ•°å€¼å­—æ®µå¦‚æœä¸ºnullï¼Œåˆ™è¾“å‡ºä¸º0 é‡å†™writeInternalæ–¹æ³•ï¼Œå¯ä»¥é‡æ–°æ„é€ è¿”å›å¯¹è±¡ï¼Œè¾¾åˆ°ç»Ÿä¸€çš„è¿”å›å€¼ setDateFormat(â€œYYYY-MM-ddâ€);è®¾ç½®æ—¥æœŸç±»å‹çš„è¿”å›æ ¼å¼ httpmessageconvertåœ¨è‡ªåŠ¨é…ç½®jacksonï¼Œé»˜è®¤ä½¿ç”¨ç”¨jackson ã€‚æ‰€ä»¥å¦‚æœè¿”å›ç±»å‹ä¸ºapplication/jsonçš„æ•°æ®ä½¿ç”¨jackson ã€‚æ‰€ä»¥å»é™¤jacksonçš„ä¾èµ–ã€‚

   &lt;dependency&gt;
		&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
		&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
		&lt;exclusions&gt;
			&lt;exclusion&gt;
				&lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;
				&lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;
			&lt;/exclusion&gt;
		&lt;/exclusions&gt;
	&lt;/dependency&gt; 1 2 3 4 5 6 7 8 9 10 ä¸å»ä¾èµ–çš„å†™æ³•

@Configuration
@ConditionalOnClass({FastJsonHttpMessageConverter.class}) //1
@ConditionalOnProperty(//2
        name = {"spring.http.converters.preferred-json-mapper"},
        havingValue = "fastjson",
        matchIfMissing = true
)
protected static class FastJson2HttpMessageConverterConfiguration {
    protected FastJson2HttpMessageConverterConfiguration() {
    }
    @Bean
    @ConditionalOnMissingBean({FastJsonHttpMessageConverter.class})//3
    public FastJsonHttpMessageConverter fastJsonHttpMessageConverter() {
        //åˆ›å»ºfastJsonæ¶ˆæ¯è½¬æ¢å™¨
        FastJsonHttpMessageConverter fastConverter = new FastJsonHttpMessageConverter(){
            protected void writeInternal(Object obj, HttpOutputMessage outputMessage){
                try {
                    if(obj instanceof PreUser){
                        Map&lt;String,Object&gt; map = new HashMap&lt;&gt;();
                        map.put("result","success");
                        map.put("preUser",obj);
                        super.writeInternal( map, outputMessage);
                    }else{
                        super.writeInternal( obj, outputMessage);
                    }
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
        };
        //  FastJsonHttpMessageConverter fastConverter = new FastJsonHttpMessageConverter();
        List&lt;MediaType&gt; supportedMediaTypes = new ArrayList&lt;&gt;();
        supportedMediaTypes.add(MediaType.APPLICATION_JSON);
        supportedMediaTypes.add(MediaType.APPLICATION_JSON_UTF8);
        fastConverter.setSupportedMediaTypes(supportedMediaTypes);

        //åˆ›å»ºé…ç½®ç±»
        FastJsonConfig fastJsonConfig = new FastJsonConfig();
        fastJsonConfig.setCharset(Charset.forName("UTF-8"));
        fastJsonConfig.setDateFormat("YYYY-MM-dd");

        //ä¿®æ”¹é…ç½®è¿”å›å†…å®¹çš„è¿‡æ»¤
        fastJsonConfig.setSerializerFeatures(
                SerializerFeature.DisableCircularReferenceDetect,
                SerializerFeature.WriteMapNullValue,
                SerializerFeature.WriteNullStringAsEmpty,
                SerializerFeature.PrettyFormat
        );
        fastConverter.setFastJsonConfig(fastJsonConfig);
        //å°†fastjsonæ·»åŠ åˆ°è§†å›¾æ¶ˆæ¯è½¬æ¢å™¨åˆ—è¡¨å†…
       // converters.add(fastConverter);
        return fastConverter;
    }
} 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 application.ymlæ·»åŠ é…ç½®
</code></pre></div></div>

<p>spring:
  http:
    converters:
      preferred-json-mapper: fastjson
1
2
3
4
ä»¥ä¸Šä»£ç åˆ¤æ–­è¿”å›ç±»å‹PreUserçš„å¯¹è±¡ï¼Œè¿›è¡Œé‡å†™ã€‚è¿”å›æ•°æ®ä¸º</p>

<p>{
	â€œresultâ€:â€successâ€,
	â€œpreUserâ€:{
		â€œaddressâ€:â€å¹¿ä¸œå¹¿å·å¤©æ²³â€,
		â€œageâ€:29,
		â€œdateâ€:â€2018-09-20â€,
		â€œdescâ€:â€tom is 29 years oldâ€,
		â€œhobbyâ€:[
			â€œæ‰“çƒâ€,
			â€œå†™ä»£ç â€
		],
		â€œnameâ€:â€tomâ€,
		â€œphoneâ€:â€â€
	}
}
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
é…ç½®CORSè·¨åŸŸ</p>

<p>Springæ—¢ç„¶ä¸ºäº†é›†æˆäº†CROSï¼Œé‚£å°±è¯æ˜äº†ä¸€ç‚¹ï¼Œä»¥åå‰åç«¯åˆ†ç¦»æ˜¯ä¸€ä¸ªå¼€å‘è¶‹åŠ¿</p>

<p>/**
     * è·¨åŸŸCORSé…ç½®
     * @param registry
     <em>/
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        super.addCorsMappings(registry);
        registry.addMapping(â€œ/cors/**â€)
                .allowedHeaders(â€œ</em>â€)
                .allowedMethods(â€œPOSTâ€,â€GETâ€)
                .allowedOrigins(â€œ*â€);
    }<br />
1
2
3
4
5
6
7
8
9
10
11
12
&lt;!DOCTYPE html&gt;</p>
<html>
	<head>
		<meta charset="UTF-8" />
		<title></title>
		<script src="js/jquery.min.js"></script>
		<script>
            $.ajax({
                type:"GET",
                url: "http://localhost:8080/preUser",
                dataType:"json",
                success:function(data, status, xhr){
                    console.log(data);
                    console.log(xhr.getAllResponseHeaders());
                },
                error:function(jqXHR){
                    console.log("Error: "+jqXHR.status);
                }
            });
		</script>
	</head>
	<body>
		cores.html
	</body>
</html>

<p>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
éªŒè¯è®¿é—®ï¼šhttp://127.0.0.1:8080/web/cors.html,æ²¡è®¾ç½®addCorsMappings()æŠ¥è·¨åŸŸå¼‚å¸¸ã€‚</p>

<p>é…ç½®æ‹¦æˆªå™¨</p>

<p>åœ¨ä¹‹å‰Xmlé…ç½®å½¢å¼å¤©ä¸‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬éƒ½æ˜¯åœ¨spring-mvc.xmlé…ç½®æ–‡ä»¶å†…æ·»åŠ <mvc:interceptor>æ ‡ç­¾é…ç½®æ‹¦æˆªå™¨ã€‚</mvc:interceptor></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/**
 * æ‹¦æˆªå™¨é…ç½®
 * @param registry
 */
@Override
public void addInterceptors(InterceptorRegistry registry) {
    registry.addInterceptor(new CustomHandlerInterceptor()).addPathPatterns("/**");
} 1 2 3 4 5 6 7 8 InterceptorRegistryå†…çš„addInterceptoréœ€è¦ä¸€ä¸ªå®ç°HandlerInterceptoræ¥å£çš„æ‹¦æˆªå™¨å®ä¾‹ï¼ŒaddPathPatternsæ–¹æ³•ç”¨äºè®¾ç½®æ‹¦æˆªå™¨çš„è¿‡æ»¤è·¯å¾„è§„åˆ™Â·ã€‚excludePathPatterns è¡¨ç¤ºä¸æ‹¦æˆªã€‚
</code></pre></div></div>

<p>@Slf4j
public class CustomHandlerInterceptor implements HandlerInterceptor {
    @Override
    public boolean preHandle(HttpServletRequest request,
                             HttpServletResponse response, Object handler)
            throws Exception {
        log.info(â€œpreHandle:è¯·æ±‚å‰è°ƒç”¨â€);
        //è¿”å› false åˆ™è¯·æ±‚ä¸­æ–­
        return true;
    }</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@Override
public void postHandle(HttpServletRequest request,
                       HttpServletResponse response, Object handler,
                       ModelAndView modelAndView) throws Exception {
    log.info("postHandle:è¯·æ±‚åè°ƒç”¨");
}

@Override
public void afterCompletion(HttpServletRequest request,
                            HttpServletResponse response, Object handler, Exception ex)
        throws Exception {
    log.info("afterCompletion:è¯·æ±‚è°ƒç”¨å®Œæˆåå›è°ƒæ–¹æ³•ï¼Œå³åœ¨è§†å›¾æ¸²æŸ“å®Œæˆåå›è°ƒ");
} }
</code></pre></div></div>

<p>æ¯æ¬¡è¯·æ±‚æ—¶æ‰“å°</p>

<p>2018-12-24 22:21:34.434  INFO 2156 â€” [io-8080-exec-10]  : preHandle:è¯·æ±‚å‰è°ƒç”¨
2018-12-24 22:21:34.436  INFO 2156 â€” [io-8080-exec-10]  : postHandle:è¯·æ±‚åè°ƒç”¨
2018-12-24 22:21:34.436  INFO 2156 â€” [io-8080-exec-10]  : afterCompletion:è¯·æ±‚è°ƒç”¨å®Œæˆåå›è°ƒæ–¹æ³•ï¼Œå³åœ¨è§†å›¾æ¸²æŸ“å®Œæˆåå›è°ƒ</p>
:ET