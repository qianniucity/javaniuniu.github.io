I"ªŠ<h4 id="ç®€ä»‹">ç®€ä»‹</h4>
<p>MultipartResolver ç”¨äºå¤„ç†æ–‡ä»¶ä¸Šä¼ ï¼Œå½“æ”¶åˆ°è¯·æ±‚æ—¶ DispatcherServlet çš„ checkMultipart() æ–¹æ³•ä¼šè°ƒç”¨ MultipartResolver çš„ isMultipart() æ–¹æ³•åˆ¤æ–­è¯·æ±‚ä¸­æ˜¯å¦åŒ…å«æ–‡ä»¶ã€‚å¦‚æœè¯·æ±‚æ•°æ®ä¸­åŒ…å«æ–‡ä»¶ï¼Œåˆ™è°ƒç”¨ MultipartResolver çš„ resolveMultipart() æ–¹æ³•å¯¹è¯·æ±‚çš„æ•°æ®è¿›è¡Œè§£æï¼Œç„¶åå°†æ–‡ä»¶æ•°æ®è§£ææˆ MultipartFile å¹¶å°è£…åœ¨ MultipartHttpServletRequest (ç»§æ‰¿äº† HttpServletRequest) å¯¹è±¡ä¸­ï¼Œæœ€åä¼ é€’ç»™ Controllerï¼Œåœ¨ MultipartResolver æ¥å£ä¸­æœ‰å¦‚ä¸‹æ–¹æ³•ï¼š</p>

<ul>
  <li>boolean isMultipart(HttpServletRequest request); // æ˜¯å¦æ˜¯ multipart</li>
  <li>MultipartHttpServletRequest resolveMultipart(HttpServletRequest request); // è§£æè¯·æ±‚</li>
  <li>void cleanupMultipart(MultipartHttpServletRequest request);</li>
</ul>

<p>MultipartFile å°è£…äº†è¯·æ±‚æ•°æ®ä¸­çš„æ–‡ä»¶ï¼Œæ­¤æ—¶è¿™ä¸ªæ–‡ä»¶å­˜å‚¨åœ¨å†…å­˜ä¸­æˆ–ä¸´æ—¶çš„ç£ç›˜æ–‡ä»¶ä¸­ï¼Œéœ€è¦å°†å…¶è½¬å­˜åˆ°ä¸€ä¸ªåˆé€‚çš„ä½ç½®ï¼Œå› ä¸ºè¯·æ±‚ç»“æŸåä¸´æ—¶å­˜å‚¨å°†è¢«æ¸…ç©ºã€‚åœ¨ MultipartFile æ¥å£ä¸­æœ‰å¦‚ä¸‹æ–¹æ³•ï¼š</p>

<ul>
  <li>String getName(); // è·å–å‚æ•°çš„åç§°</li>
  <li>String getOriginalFilename(); // è·å–æ–‡ä»¶çš„åŸåç§°</li>
  <li>String getContentType(); // æ–‡ä»¶å†…å®¹çš„ç±»å‹</li>
  <li>boolean isEmpty(); // æ–‡ä»¶æ˜¯å¦ä¸ºç©º</li>
  <li>long getSize(); // æ–‡ä»¶å¤§å°</li>
  <li>byte[] getBytes(); // å°†æ–‡ä»¶å†…å®¹ä»¥å­—èŠ‚æ•°ç»„çš„å½¢å¼è¿”å›</li>
  <li>InputStream getInputStream(); // å°†æ–‡ä»¶å†…å®¹ä»¥è¾“å…¥æµçš„å½¢å¼è¿”å›</li>
  <li>void transferTo(File dest); // å°†æ–‡ä»¶å†…å®¹ä¼ è¾“åˆ°æŒ‡å®šæ–‡ä»¶ä¸­</li>
</ul>

<p><strong>MultipartResolver æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒçš„å®ç°ç±»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåˆ†ä¸º CommonsMultipartResolver ç±»å’Œ StandardServletMultipartResolver ç±»ã€‚</strong>
å…¶ä¸­ CommonsMultipartResolver ä½¿ç”¨ commons Fileupload æ¥å¤„ç† multipart è¯·æ±‚ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨æ—¶ï¼Œå¿…é¡»è¦å¼•å…¥ç›¸åº”çš„ jar åŒ…ï¼›è€Œ StandardServletMultipartResolver æ˜¯åŸºäº Servlet 3.0æ¥å¤„ç† multipart è¯·æ±‚çš„ï¼Œæ‰€ä»¥ä¸éœ€è¦å¼•ç”¨å…¶ä»– jar åŒ…ï¼Œä½†æ˜¯å¿…é¡»ä½¿ç”¨æ”¯æŒ Servlet 3.0çš„å®¹å™¨æ‰å¯ä»¥ï¼Œä»¥tomcatä¸ºä¾‹ï¼Œä» Tomcat 7.0.xçš„ç‰ˆæœ¬å¼€å§‹å°±æ”¯æŒ Servlet 3.0äº†ã€‚</p>

<p>ä¸€ã€CommonsMultipartResolver</p>

<p>1 ä½¿ç”¨æ–¹å¼</p>

<p>1.1 é…ç½®æ–‡ä»¶</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- å®šä¹‰æ–‡ä»¶ä¸Šä¼ è§£æå™¨ --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"multipartResolver"</span> <span class="na">class=</span><span class="s">"org.springframework.web.multipart.commons.CommonsMultipartResolver"</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- è®¾å®šé»˜è®¤ç¼–ç  --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"defaultEncoding"</span> <span class="na">value=</span><span class="s">"UTF-8"</span><span class="nt">&gt;&lt;/property&gt;</span>
    <span class="c">&lt;!-- è®¾å®šæ–‡ä»¶ä¸Šä¼ çš„æœ€å¤§å€¼ä¸º5MBï¼Œ5*1024*1024 --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"maxUploadSize"</span> <span class="na">value=</span><span class="s">"5242880"</span><span class="nt">&gt;&lt;/property&gt;</span>
    <span class="c">&lt;!-- è®¾å®šæ–‡ä»¶ä¸Šä¼ æ—¶å†™å…¥å†…å­˜çš„æœ€å¤§å€¼ï¼Œå¦‚æœå°äºè¿™ä¸ªå‚æ•°ä¸ä¼šç”Ÿæˆä¸´æ—¶æ–‡ä»¶ï¼Œé»˜è®¤ä¸º10240 --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"maxInMemorySize"</span> <span class="na">value=</span><span class="s">"40960"</span><span class="nt">&gt;&lt;/property&gt;</span>
    <span class="c">&lt;!-- ä¸Šä¼ æ–‡ä»¶çš„ä¸´æ—¶è·¯å¾„ --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"uploadTempDir"</span> <span class="na">value=</span><span class="s">"fileUpload/temp"</span><span class="nt">&gt;&lt;/property&gt;</span>
    <span class="c">&lt;!-- å»¶è¿Ÿæ–‡ä»¶è§£æ --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"resolveLazily"</span> <span class="na">value=</span><span class="s">"true"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</code></pre></div></div>

<p>1.2 ä¸Šä¼ è¡¨å•</p>

<p>è¦åœ¨ form æ ‡ç­¾ä¸­åŠ å…¥ enctype=â€multipart/form-dataâ€ è¡¨ç¤ºè¯¥è¡¨å•è¦æäº¤æ–‡ä»¶ã€‚</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"${pageContext.request.contextPath}/test/file-upload.do"</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">enctype=</span><span class="s">"multipart/form-data"</span><span class="nt">&gt;</span>
     <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"file"</span> <span class="na">name=</span><span class="s">"file"</span><span class="nt">&gt;</span>
     <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"æäº¤"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</code></pre></div></div>
<p>1.3 å¤„ç†æ–‡ä»¶</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/file-upload"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">ModelAndView</span> <span class="nf">upload</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"file"</span><span class="o">,</span> <span class="n">required</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span> <span class="nc">MultipartFile</span> <span class="n">file</span><span class="o">,</span>
<span class="err">ã€€ã€€ã€€ã€€ã€€ã€€</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpSession</span> <span class="n">session</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// æ–‡ä»¶ä¸ä¸ºç©º</span>
    <span class="k">if</span><span class="o">(!</span><span class="n">file</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="c1">// æ–‡ä»¶å­˜æ”¾è·¯å¾„</span>
        <span class="nc">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getServletContext</span><span class="o">().</span><span class="na">getRealPath</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
        <span class="c1">// æ–‡ä»¶åç§°</span>
        <span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">().</span><span class="na">getTime</span><span class="o">()+</span><span class="s">"_"</span><span class="o">+</span><span class="n">file</span><span class="o">.</span><span class="na">getOriginalFilename</span><span class="o">());</span>
        <span class="nc">File</span> <span class="n">destFile</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">path</span><span class="o">,</span><span class="n">name</span><span class="o">);</span>
        <span class="c1">// è½¬å­˜æ–‡ä»¶</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">file</span><span class="o">.</span><span class="na">transferTo</span><span class="o">(</span><span class="n">destFile</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IllegalStateException</span> <span class="o">|</span> <span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="c1">// è®¿é—®çš„url</span>
        <span class="nc">String</span> <span class="n">url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getScheme</span><span class="o">()</span> <span class="o">+</span> <span class="s">"://"</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="na">getServerName</span><span class="o">()</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="na">getServerPort</span><span class="o">()</span>
<span class="err">ã€€ã€€ã€€ã€€ã€€ã€€</span><span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="na">getContextPath</span><span class="o">()</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>        
    <span class="nc">ModelAndView</span> <span class="n">mv</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ModelAndView</span><span class="o">();</span>
    <span class="n">mv</span><span class="o">.</span><span class="na">setViewName</span><span class="o">(</span><span class="s">"other/home"</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">mv</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<p>2 æºç åˆ†æ</p>

<p>CommonsMultipartResolver å®ç°äº† MultipartResolver æ¥å£ï¼ŒresolveMultipart() æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼Œå…¶ä¸­ resolveLazily æ˜¯åˆ¤æ–­æ˜¯å¦è¦å»¶è¿Ÿè§£ææ–‡ä»¶ï¼ˆé€šè¿‡XMLå¯ä»¥è®¾ç½®ï¼‰ã€‚å½“ resolveLazily ä¸º flase æ—¶ï¼Œä¼šç«‹å³è°ƒç”¨ parseRequest() æ–¹æ³•å¯¹è¯·æ±‚æ•°æ®è¿›è¡Œè§£æï¼Œç„¶åå°†è§£æç»“æœå°è£…åˆ° DefaultMultipartHttpServletRequest ä¸­ï¼›è€Œå½“ resolveLazily ä¸º true æ—¶ï¼Œä¼šåœ¨ DefaultMultipartHttpServletRequest çš„ initializeMultipart() æ–¹æ³•è°ƒç”¨ parseRequest() æ–¹æ³•å¯¹è¯·æ±‚æ•°æ®è¿›è¡Œè§£æï¼Œè€Œ initializeMultipart() æ–¹æ³•åˆæ˜¯è¢« getMultipartFiles() æ–¹æ³•è°ƒç”¨ï¼Œå³å½“éœ€è¦è·å–æ–‡ä»¶ä¿¡æ¯æ—¶æ‰ä¼šå»è§£æè¯·æ±‚æ•°æ®ï¼Œè¿™ç§æ–¹å¼ç”¨äº†æ‡’åŠ è½½çš„æ€æƒ³ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">MultipartHttpServletRequest</span> <span class="nf">resolveMultipart</span><span class="o">(</span><span class="kd">final</span> <span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">MultipartException</span> <span class="o">{</span>
    <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="s">"Request must not be null"</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">resolveLazily</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//æ‡’åŠ è½½ï¼Œå½“è°ƒç”¨DefaultMultipartHttpServletRequestçš„getMultipartFiles()æ–¹æ³•æ—¶æ‰è§£æè¯·æ±‚æ•°æ®</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">DefaultMultipartHttpServletRequest</span><span class="o">(</span><span class="n">request</span><span class="o">)</span> <span class="o">{</span>
            <span class="nd">@Override</span> <span class="c1">//å½“getMultipartFiles()æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œå¦‚æœè¿˜æœªè§£æè¯·æ±‚æ•°æ®ï¼Œåˆ™è°ƒç”¨initializeMultipart()æ–¹æ³•è¿›è¡Œè§£æ protected void initializeMultipart() {</span>
                <span class="nc">MultipartParsingResult</span> <span class="n">parsingResult</span> <span class="o">=</span> <span class="n">parseRequest</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
                <span class="n">setMultipartFiles</span><span class="o">(</span><span class="n">parsingResult</span><span class="o">.</span><span class="na">getMultipartFiles</span><span class="o">());</span>
                <span class="n">setMultipartParameters</span><span class="o">(</span><span class="n">parsingResult</span><span class="o">.</span><span class="na">getMultipartParameters</span><span class="o">());</span>
                <span class="n">setMultipartParameterContentTypes</span><span class="o">(</span><span class="n">parsingResult</span><span class="o">.</span><span class="na">getMultipartParameterContentTypes</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">};</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="c1">//ç«‹å³è§£æè¯·æ±‚æ•°æ®ï¼Œå¹¶å°†è§£æç»“æœå°è£…åˆ°DefaultMultipartHttpServletRequestå¯¹è±¡ä¸­</span>
        <span class="nc">MultipartParsingResult</span> <span class="n">parsingResult</span> <span class="o">=</span> <span class="n">parseRequest</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">DefaultMultipartHttpServletRequest</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">parsingResult</span><span class="o">.</span><span class="na">getMultipartFiles</span><span class="o">(),</span>
              <span class="n">parsingResult</span><span class="o">.</span><span class="na">getMultipartParameters</span><span class="o">(),</span> <span class="n">parsingResult</span><span class="o">.</span><span class="na">getMultipartParameterContentTypes</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå¯¹è¯·æ±‚æ•°æ®çš„è§£æå·¥ä½œæ˜¯åœ¨ parseRequest() æ–¹æ³•ä¸­è¿›è¡Œçš„ï¼Œç»§ç»­çœ‹ä¸€ä¸‹ parseRequest() æ–¹æ³•æºç </p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="nc">MultipartParsingResult</span> <span class="nf">parseRequest</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">MultipartException</span> <span class="o">{</span>
    <span class="c1">// è·å–è¯·æ±‚çš„ç¼–ç ç±»å‹</span>
    <span class="nc">String</span> <span class="n">encoding</span> <span class="o">=</span> <span class="n">determineEncoding</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
    <span class="nc">FileUpload</span> <span class="n">fileUpload</span> <span class="o">=</span> <span class="n">prepareFileUpload</span><span class="o">(</span><span class="n">encoding</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">FileItem</span><span class="o">&gt;</span> <span class="n">fileItems</span> <span class="o">=</span> <span class="o">((</span><span class="nc">ServletFileUpload</span><span class="o">)</span> <span class="n">fileUpload</span><span class="o">).</span><span class="na">parseRequest</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
        <span class="k">return</span> <span class="nf">parseFileItems</span><span class="o">(</span><span class="n">fileItems</span><span class="o">,</span> <span class="n">encoding</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(...)</span> <span class="o">{}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>åœ¨ parseRequest() æ–¹æ³•ä¸­ï¼Œé¦–å…ˆè°ƒç”¨äº† prepareFileUpload() æ–¹æ³•æ¥æ ¹æ®ç¼–ç ç±»å‹ç¡®å®šä¸€ä¸ª FileUpload å®ä¾‹ï¼Œç„¶ååˆ©ç”¨è¿™ä¸ª FileUpload å®ä¾‹è§£æè¯·æ±‚æ•°æ®åå¾—åˆ°æ–‡ä»¶ä¿¡æ¯ï¼Œæœ€åå°†æ–‡ä»¶ä¿¡æ¯è§£ææˆ CommonsMultipartFile (å®ç°äº† MultipartFile æ¥å£) å¹¶åŒ…è£…åœ¨ MultipartParsingResult å¯¹è±¡ä¸­ã€‚</p>

<p>äºŒã€StandardServletMultipartResolver</p>

<p>1 ä½¿ç”¨æ–¹å¼</p>

<p>1.1 é…ç½®æ–‡ä»¶</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"multipartResolver"</span> <span class="na">class=</span><span class="s">"org.springframework.web.multipart.support.StandardServletMultipartResolver"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</code></pre></div></div>
<p>è¿™é‡Œå¹¶æ²¡æœ‰é…ç½®æ–‡ä»¶å¤§å°ç­‰å‚æ•°ï¼Œè¿™äº›å‚æ•°çš„é…ç½®åœ¨ web.xml ä¸­</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;servlet&gt;</span>
    <span class="nt">&lt;servlet-name&gt;</span>springmvc<span class="nt">&lt;/servlet-name&gt;</span>
    <span class="nt">&lt;servlet-class&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="nt">&lt;/servlet-class&gt;</span>
    <span class="nt">&lt;init-param&gt;</span>  
        <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>  
        <span class="nt">&lt;param-value&gt;</span>classpath:springmvc.xml<span class="nt">&lt;/param-value&gt;</span>  
    <span class="nt">&lt;/init-param&gt;</span>  
    <span class="nt">&lt;load-on-startup&gt;</span>1<span class="nt">&lt;/load-on-startup&gt;</span>
    <span class="nt">&lt;multipart-config&gt;</span>
        <span class="c">&lt;!-- ä¸´æ—¶æ–‡ä»¶çš„ç›®å½• --&gt;</span>
        <span class="nt">&lt;location&gt;</span>d:/<span class="nt">&lt;/location&gt;</span>
        <span class="c">&lt;!-- ä¸Šä¼ æ–‡ä»¶æœ€å¤§2M --&gt;</span>
        <span class="nt">&lt;max-file-size&gt;</span>2097152<span class="nt">&lt;/max-file-size&gt;</span>
        <span class="c">&lt;!-- ä¸Šä¼ æ–‡ä»¶æ•´ä¸ªè¯·æ±‚ä¸è¶…è¿‡4M --&gt;</span>
        <span class="nt">&lt;max-request-size&gt;</span>4194304<span class="nt">&lt;/max-request-size&gt;</span>
    <span class="nt">&lt;/multipart-config&gt;</span>
<span class="nt">&lt;/servlet&gt;</span>
</code></pre></div></div>
<p>1.2 ä¸Šä¼ è¡¨å•</p>

<p>è¦åœ¨ form æ ‡ç­¾ä¸­åŠ å…¥ enctype=â€multipart/form-dataâ€ è¡¨ç¤ºè¯¥è¡¨å•è¦æäº¤æ–‡ä»¶ã€‚</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"${pageContext.request.contextPath}/test/file-upload.do"</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">enctype=</span><span class="s">"multipart/form-data"</span><span class="nt">&gt;</span>
     <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"file"</span> <span class="na">name=</span><span class="s">"file"</span><span class="nt">&gt;</span>
     <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"æäº¤"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</code></pre></div></div>
<p>1.3 å¤„ç†æ–‡ä»¶</p>

<p>1.3.1 é€šè¿‡ MultipartFile ç±»å‹çš„å‚æ•°</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/file-upload"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">ModelAndView</span> <span class="nf">upload</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"file"</span><span class="o">,</span> <span class="n">required</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span> <span class="nc">MultipartFile</span> <span class="n">file</span><span class="o">,</span>
<span class="err">ã€€ã€€ã€€ã€€ã€€ã€€</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpSession</span> <span class="n">session</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// æ–‡ä»¶ä¸ä¸ºç©º</span>
    <span class="k">if</span><span class="o">(!</span><span class="n">file</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="c1">// æ–‡ä»¶å­˜æ”¾è·¯å¾„</span>
        <span class="nc">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getServletContext</span><span class="o">().</span><span class="na">getRealPath</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
        <span class="c1">// æ–‡ä»¶åç§°</span>
        <span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">().</span><span class="na">getTime</span><span class="o">()+</span><span class="s">"_"</span><span class="o">+</span><span class="n">file</span><span class="o">.</span><span class="na">getOriginalFilename</span><span class="o">());</span>
        <span class="nc">File</span> <span class="n">destFile</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">path</span><span class="o">,</span><span class="n">name</span><span class="o">);</span>
        <span class="c1">// è½¬å­˜æ–‡ä»¶</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">file</span><span class="o">.</span><span class="na">transferTo</span><span class="o">(</span><span class="n">destFile</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IllegalStateException</span> <span class="o">|</span> <span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="c1">// è®¿é—®çš„url</span>
        <span class="nc">String</span> <span class="n">url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getScheme</span><span class="o">()</span> <span class="o">+</span> <span class="s">"://"</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="na">getServerName</span><span class="o">()</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="na">getServerPort</span><span class="o">()</span>
<span class="err">ã€€ã€€ã€€ã€€ã€€ã€€</span><span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="na">getContextPath</span><span class="o">()</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>        
    <span class="nc">ModelAndView</span> <span class="n">mv</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ModelAndView</span><span class="o">();</span>
    <span class="n">mv</span><span class="o">.</span><span class="na">setViewName</span><span class="o">(</span><span class="s">"other/home"</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">mv</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<p>1.3.2 é€šè¿‡ MultipartHttpServletRequest ç±»å‹çš„å‚æ•°</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/file-upload"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">ModelAndView</span> <span class="nf">upload</span><span class="o">(</span><span class="nc">MultipartHttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpSession</span> <span class="n">session</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// æ ¹æ®é¡µé¢inputæ ‡ç­¾çš„name</span>
    <span class="nc">MultipartFile</span> <span class="n">file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getFile</span><span class="o">(</span><span class="s">"file"</span><span class="o">);</span>
    <span class="c1">// æ–‡ä»¶ä¸ä¸ºç©º</span>
    <span class="k">if</span><span class="o">(!</span><span class="n">file</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="c1">// æ–‡ä»¶å­˜æ”¾è·¯å¾„</span>
        <span class="nc">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getServletContext</span><span class="o">().</span><span class="na">getRealPath</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
        <span class="c1">// æ–‡ä»¶åç§°</span>
        <span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">().</span><span class="na">getTime</span><span class="o">()+</span><span class="s">"_"</span><span class="o">+</span><span class="n">file</span><span class="o">.</span><span class="na">getOriginalFilename</span><span class="o">());</span>
        <span class="nc">File</span> <span class="n">destFile</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">path</span><span class="o">,</span><span class="n">name</span><span class="o">);</span>
        <span class="c1">// è½¬å­˜æ–‡ä»¶</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">file</span><span class="o">.</span><span class="na">transferTo</span><span class="o">(</span><span class="n">destFile</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IllegalStateException</span> <span class="o">|</span> <span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="c1">// è®¿é—®çš„url</span>
        <span class="nc">String</span> <span class="n">url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getScheme</span><span class="o">()</span> <span class="o">+</span> <span class="s">"://"</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="na">getServerName</span><span class="o">()</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="na">getServerPort</span><span class="o">()</span>
<span class="err">ã€€ã€€ã€€ã€€ã€€ã€€</span><span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="na">getContextPath</span><span class="o">()</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>        
    <span class="nc">ModelAndView</span> <span class="n">mv</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ModelAndView</span><span class="o">();</span>
    <span class="n">mv</span><span class="o">.</span><span class="na">setViewName</span><span class="o">(</span><span class="s">"other/home"</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">mv</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<p>2 æºç åˆ†æ</p>

<p>StandardServletMultipartResolver å®ç°äº† MultipartResolver æ¥å£ï¼ŒresolveMultipart() æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼Œå…¶ä¸­ resolveLazily æ˜¯åˆ¤æ–­æ˜¯å¦è¦å»¶è¿Ÿè§£ææ–‡ä»¶ï¼ˆé€šè¿‡XMLå¯ä»¥è®¾ç½®ï¼‰ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">MultipartHttpServletRequest</span> <span class="nf">resolveMultipart</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">MultipartException</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">StandardMultipartHttpServletRequest</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">resolveLazily</span><span class="o">);</span>
<span class="o">}</span>
<span class="kd">public</span> <span class="nf">StandardMultipartHttpServletRequest</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">lazyParsing</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">MultipartException</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
    <span class="c1">// åˆ¤æ–­æ˜¯å¦ç«‹å³è§£æ</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">lazyParsing</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">parseRequest</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>å¯¹è¯·æ±‚æ•°æ®çš„è§£æå·¥ä½œæ˜¯åœ¨ parseRequest() æ–¹æ³•ä¸­è¿›è¡Œçš„ï¼Œç»§ç»­çœ‹ä¸€ä¸‹ parseRequest() æ–¹æ³•æºç </p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">parseRequest</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">Part</span><span class="o">&gt;</span> <span class="n">parts</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParts</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">multipartParameterNames</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;(</span><span class="n">parts</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
        <span class="nc">MultiValueMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">MultipartFile</span><span class="o">&gt;</span> <span class="n">files</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedMultiValueMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">MultipartFile</span><span class="o">&gt;(</span><span class="n">parts</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Part</span> <span class="n">part</span> <span class="o">:</span> <span class="n">parts</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">disposition</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="no">CONTENT_DISPOSITION</span><span class="o">);</span>
            <span class="nc">String</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">extractFilename</span><span class="o">(</span><span class="n">disposition</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">filename</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">extractFilenameWithCharset</span><span class="o">(</span><span class="n">disposition</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">filename</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">files</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">part</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="k">new</span> <span class="nc">StandardMultipartFile</span><span class="o">(</span><span class="n">part</span><span class="o">,</span> <span class="n">filename</span><span class="o">));</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">this</span><span class="o">.</span><span class="na">multipartParameterNames</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">part</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">setMultipartFiles</span><span class="o">(</span><span class="n">files</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>parseRequest() æ–¹æ³•åˆ©ç”¨äº† servlet3.0 çš„ request.getParts() æ–¹æ³•è·å–ä¸Šä¼ æ–‡ä»¶ï¼Œå¹¶å°†å…¶å°è£…åˆ° MultipartFile å¯¹è±¡ä¸­ã€‚</p>
:ET