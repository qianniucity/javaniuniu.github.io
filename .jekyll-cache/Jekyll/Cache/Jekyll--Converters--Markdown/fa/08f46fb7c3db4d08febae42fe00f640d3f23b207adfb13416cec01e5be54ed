I"î2<h4 id="ç®€ä»‹">ç®€ä»‹</h4>
<p>MultipartResolver ç”¨äºå¤„ç†æ–‡ä»¶ä¸Šä¼ ï¼Œå½“æ”¶åˆ°è¯·æ±‚æ—¶ DispatcherServlet çš„ checkMultipart() æ–¹æ³•ä¼šè°ƒç”¨ MultipartResolver çš„ isMultipart() æ–¹æ³•åˆ¤æ–­è¯·æ±‚ä¸­æ˜¯å¦åŒ…å«æ–‡ä»¶ã€‚å¦‚æœè¯·æ±‚æ•°æ®ä¸­åŒ…å«æ–‡ä»¶ï¼Œåˆ™è°ƒç”¨ MultipartResolver çš„ resolveMultipart() æ–¹æ³•å¯¹è¯·æ±‚çš„æ•°æ®è¿›è¡Œè§£æï¼Œç„¶åå°†æ–‡ä»¶æ•°æ®è§£ææˆ MultipartFile å¹¶å°è£…åœ¨ MultipartHttpServletRequest (ç»§æ‰¿äº† HttpServletRequest) å¯¹è±¡ä¸­ï¼Œæœ€åä¼ é€’ç»™ Controllerï¼Œåœ¨ MultipartResolver æ¥å£ä¸­æœ‰å¦‚ä¸‹æ–¹æ³•ï¼š</p>

<ul>
  <li>boolean isMultipart(HttpServletRequest request); // æ˜¯å¦æ˜¯ multipart</li>
  <li>MultipartHttpServletRequest resolveMultipart(HttpServletRequest request); // è§£æè¯·æ±‚</li>
  <li>void cleanupMultipart(MultipartHttpServletRequest request);</li>
</ul>

<p>MultipartFile å°è£…äº†è¯·æ±‚æ•°æ®ä¸­çš„æ–‡ä»¶ï¼Œæ­¤æ—¶è¿™ä¸ªæ–‡ä»¶å­˜å‚¨åœ¨å†…å­˜ä¸­æˆ–ä¸´æ—¶çš„ç£ç›˜æ–‡ä»¶ä¸­ï¼Œéœ€è¦å°†å…¶è½¬å­˜åˆ°ä¸€ä¸ªåˆé€‚çš„ä½ç½®ï¼Œå› ä¸ºè¯·æ±‚ç»“æŸåä¸´æ—¶å­˜å‚¨å°†è¢«æ¸…ç©ºã€‚åœ¨ MultipartFile æ¥å£ä¸­æœ‰å¦‚ä¸‹æ–¹æ³•ï¼š</p>

<ul>
  <li>String getName(); // è·å–å‚æ•°çš„åç§°</li>
  <li>String getOriginalFilename(); // è·å–æ–‡ä»¶çš„åŸåç§°</li>
  <li>String getContentType(); // æ–‡ä»¶å†…å®¹çš„ç±»å‹</li>
  <li>boolean isEmpty(); // æ–‡ä»¶æ˜¯å¦ä¸ºç©º</li>
  <li>long getSize(); // æ–‡ä»¶å¤§å°</li>
  <li>byte[] getBytes(); // å°†æ–‡ä»¶å†…å®¹ä»¥å­—èŠ‚æ•°ç»„çš„å½¢å¼è¿”å›</li>
  <li>InputStream getInputStream(); // å°†æ–‡ä»¶å†…å®¹ä»¥è¾“å…¥æµçš„å½¢å¼è¿”å›</li>
  <li>void transferTo(File dest); // å°†æ–‡ä»¶å†…å®¹ä¼ è¾“åˆ°æŒ‡å®šæ–‡ä»¶ä¸­</li>
</ul>

<p><strong>MultipartResolver æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒçš„å®ç°ç±»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåˆ†ä¸º CommonsMultipartResolver ç±»å’Œ StandardServletMultipartResolver ç±»ã€‚</strong></p>

<p>å…¶ä¸­ CommonsMultipartResolver ä½¿ç”¨ commons Fileupload æ¥å¤„ç† multipart è¯·æ±‚ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨æ—¶ï¼Œå¿…é¡»è¦å¼•å…¥ç›¸åº”çš„ jar åŒ…ï¼›è€Œ StandardServletMultipartResolver æ˜¯åŸºäº Servlet 3.0æ¥å¤„ç† multipart è¯·æ±‚çš„ï¼Œæ‰€ä»¥ä¸éœ€è¦å¼•ç”¨å…¶ä»– jar åŒ…ï¼Œä½†æ˜¯å¿…é¡»ä½¿ç”¨æ”¯æŒ Servlet 3.0çš„å®¹å™¨æ‰å¯ä»¥ï¼Œä»¥tomcatä¸ºä¾‹ï¼Œä» Tomcat 7.0.xçš„ç‰ˆæœ¬å¼€å§‹å°±æ”¯æŒ Servlet 3.0äº†ã€‚</p>

<p>ä¸€ã€CommonsMultipartResolver</p>

<p>1 ä½¿ç”¨æ–¹å¼</p>

<p>1.1 é…ç½®æ–‡ä»¶</p>

<p>å¤åˆ¶ä»£ç 
<!-- å®šä¹‰æ–‡ä»¶ä¸Šä¼ è§£æå™¨ --></p>
<bean id="multipartResolver" class="org.springframework.web.multipart.commons.CommonsMultipartResolver">
    <!-- è®¾å®šé»˜è®¤ç¼–ç  -->
    <property name="defaultEncoding" value="UTF-8"></property>
    <!-- è®¾å®šæ–‡ä»¶ä¸Šä¼ çš„æœ€å¤§å€¼ä¸º5MBï¼Œ5*1024*1024 -->
    <property name="maxUploadSize" value="5242880"></property>
    <!-- è®¾å®šæ–‡ä»¶ä¸Šä¼ æ—¶å†™å…¥å†…å­˜çš„æœ€å¤§å€¼ï¼Œå¦‚æœå°äºè¿™ä¸ªå‚æ•°ä¸ä¼šç”Ÿæˆä¸´æ—¶æ–‡ä»¶ï¼Œé»˜è®¤ä¸º10240 -->
    <property name="maxInMemorySize" value="40960"></property>
    <!-- ä¸Šä¼ æ–‡ä»¶çš„ä¸´æ—¶è·¯å¾„ -->
    <property name="uploadTempDir" value="fileUpload/temp"></property>
    <!-- å»¶è¿Ÿæ–‡ä»¶è§£æ -->
    <property name="resolveLazily" value="true" />
</bean>
<p>å¤åˆ¶ä»£ç 
1.2 ä¸Šä¼ è¡¨å•</p>

<p>è¦åœ¨ form æ ‡ç­¾ä¸­åŠ å…¥ enctype=â€multipart/form-dataâ€ è¡¨ç¤ºè¯¥è¡¨å•è¦æäº¤æ–‡ä»¶ã€‚</p>

<form action="${pageContext.request.contextPath}/test/file-upload.do" method="post" enctype="multipart/form-data">
     <input type="file" name="file" />
     <input type="submit" value="æäº¤" />
</form>
<p>1.3 å¤„ç†æ–‡ä»¶</p>

<p>å¤åˆ¶ä»£ç 
@RequestMapping(â€œ/file-uploadâ€)
public ModelAndView upload(@RequestParam(value = â€œfileâ€, required = false) MultipartFile file,
ã€€ã€€ã€€ã€€ã€€ã€€HttpServletRequest request, HttpSession session) {
    // æ–‡ä»¶ä¸ä¸ºç©º
    if(!file.isEmpty()) {
        // æ–‡ä»¶å­˜æ”¾è·¯å¾„
        String path = request.getServletContext().getRealPath(â€œ/â€);
        // æ–‡ä»¶åç§°
        String name = String.valueOf(new Date().getTime()+â€_â€œ+file.getOriginalFilename());
        File destFile = new File(path,name);
        // è½¬å­˜æ–‡ä»¶
        try {
            file.transferTo(destFile);
        } catch (IllegalStateException | IOException e) {
            e.printStackTrace();
        }
        // è®¿é—®çš„url
        String url = request.getScheme() + â€œ://â€ + request.getServerName() + â€œ:â€ + request.getServerPort()
ã€€ã€€ã€€ã€€ã€€ã€€+ request.getContextPath() + â€œ/â€ + name;
    }      <br />
    ModelAndView mv = new ModelAndView();
    mv.setViewName(â€œother/homeâ€);
    return mv;
}
å¤åˆ¶ä»£ç 
2 æºç åˆ†æ</p>

<p>CommonsMultipartResolver å®ç°äº† MultipartResolver æ¥å£ï¼ŒresolveMultipart() æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼Œå…¶ä¸­ resolveLazily æ˜¯åˆ¤æ–­æ˜¯å¦è¦å»¶è¿Ÿè§£ææ–‡ä»¶ï¼ˆé€šè¿‡XMLå¯ä»¥è®¾ç½®ï¼‰ã€‚å½“ resolveLazily ä¸º flase æ—¶ï¼Œä¼šç«‹å³è°ƒç”¨ parseRequest() æ–¹æ³•å¯¹è¯·æ±‚æ•°æ®è¿›è¡Œè§£æï¼Œç„¶åå°†è§£æç»“æœå°è£…åˆ° DefaultMultipartHttpServletRequest ä¸­ï¼›è€Œå½“ resolveLazily ä¸º true æ—¶ï¼Œä¼šåœ¨ DefaultMultipartHttpServletRequest çš„ initializeMultipart() æ–¹æ³•è°ƒç”¨ parseRequest() æ–¹æ³•å¯¹è¯·æ±‚æ•°æ®è¿›è¡Œè§£æï¼Œè€Œ initializeMultipart() æ–¹æ³•åˆæ˜¯è¢« getMultipartFiles() æ–¹æ³•è°ƒç”¨ï¼Œå³å½“éœ€è¦è·å–æ–‡ä»¶ä¿¡æ¯æ—¶æ‰ä¼šå»è§£æè¯·æ±‚æ•°æ®ï¼Œè¿™ç§æ–¹å¼ç”¨äº†æ‡’åŠ è½½çš„æ€æƒ³ã€‚</p>

<p>å¤åˆ¶ä»£ç 
@Override
public MultipartHttpServletRequest resolveMultipart(final HttpServletRequest request) throws MultipartException {
    Assert.notNull(request, â€œRequest must not be nullâ€);
    if (this.resolveLazily) {
        //æ‡’åŠ è½½ï¼Œå½“è°ƒç”¨DefaultMultipartHttpServletRequestçš„getMultipartFiles()æ–¹æ³•æ—¶æ‰è§£æè¯·æ±‚æ•°æ®
        return new DefaultMultipartHttpServletRequest(request) {
            @Override //å½“getMultipartFiles()æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œå¦‚æœè¿˜æœªè§£æè¯·æ±‚æ•°æ®ï¼Œåˆ™è°ƒç”¨initializeMultipart()æ–¹æ³•è¿›è¡Œè§£æ protected void initializeMultipart() {
                MultipartParsingResult parsingResult = parseRequest(request);
                setMultipartFiles(parsingResult.getMultipartFiles());
                setMultipartParameters(parsingResult.getMultipartParameters());
                setMultipartParameterContentTypes(parsingResult.getMultipartParameterContentTypes());
            }
        };
    } else {
        //ç«‹å³è§£æè¯·æ±‚æ•°æ®ï¼Œå¹¶å°†è§£æç»“æœå°è£…åˆ°DefaultMultipartHttpServletRequestå¯¹è±¡ä¸­
        MultipartParsingResult parsingResult = parseRequest(request);
        return new DefaultMultipartHttpServletRequest(request, parsingResult.getMultipartFiles(),
              parsingResult.getMultipartParameters(), parsingResult.getMultipartParameterContentTypes());
    }
}
å¤åˆ¶ä»£ç 
åœ¨ä¸Šé¢çš„ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå¯¹è¯·æ±‚æ•°æ®çš„è§£æå·¥ä½œæ˜¯åœ¨ parseRequest() æ–¹æ³•ä¸­è¿›è¡Œçš„ï¼Œç»§ç»­çœ‹ä¸€ä¸‹ parseRequest() æ–¹æ³•æºç </p>

<p>å¤åˆ¶ä»£ç 
protected MultipartParsingResult parseRequest(HttpServletRequest request) throws MultipartException {
    // è·å–è¯·æ±‚çš„ç¼–ç ç±»å‹
    String encoding = determineEncoding(request);
    FileUpload fileUpload = prepareFileUpload(encoding);
    try {
        List<FileItem> fileItems = ((ServletFileUpload) fileUpload).parseRequest(request);
        return parseFileItems(fileItems, encoding);
    } catch (...) {}
}
å¤åˆ¶ä»£ç 
åœ¨ parseRequest() æ–¹æ³•ä¸­ï¼Œé¦–å…ˆè°ƒç”¨äº† prepareFileUpload() æ–¹æ³•æ¥æ ¹æ®ç¼–ç ç±»å‹ç¡®å®šä¸€ä¸ª FileUpload å®ä¾‹ï¼Œç„¶ååˆ©ç”¨è¿™ä¸ª FileUpload å®ä¾‹è§£æè¯·æ±‚æ•°æ®åå¾—åˆ°æ–‡ä»¶ä¿¡æ¯ï¼Œæœ€åå°†æ–‡ä»¶ä¿¡æ¯è§£ææˆ CommonsMultipartFile (å®ç°äº† MultipartFile æ¥å£) å¹¶åŒ…è£…åœ¨ MultipartParsingResult å¯¹è±¡ä¸­ã€‚</FileItem></p>

<p>äºŒã€StandardServletMultipartResolver</p>

<p>1 ä½¿ç”¨æ–¹å¼</p>

<p>1.1 é…ç½®æ–‡ä»¶</p>

<bean id="multipartResolver" class="org.springframework.web.multipart.support.StandardServletMultipartResolver">
</bean>
<p>è¿™é‡Œå¹¶æ²¡æœ‰é…ç½®æ–‡ä»¶å¤§å°ç­‰å‚æ•°ï¼Œè¿™äº›å‚æ•°çš„é…ç½®åœ¨ web.xml ä¸­</p>

<p>å¤åˆ¶ä»£ç </p>
<servlet>
    <servlet-name>springmvc</servlet-name>
    <servlet-class>org.springframework.web.servlet.DispatcherServlet</servlet-class>
    <init-param>  
        <param-name>contextConfigLocation</param-name>  
        <param-value>classpath:springmvc.xml</param-value>  
    </init-param>  
    <load-on-startup>1</load-on-startup>
    <multipart-config>
        <!-- ä¸´æ—¶æ–‡ä»¶çš„ç›®å½• -->
        <location>d:/</location>
        <!-- ä¸Šä¼ æ–‡ä»¶æœ€å¤§2M -->
        <max-file-size>2097152</max-file-size>
        <!-- ä¸Šä¼ æ–‡ä»¶æ•´ä¸ªè¯·æ±‚ä¸è¶…è¿‡4M -->
        <max-request-size>4194304</max-request-size>
    </multipart-config>
</servlet>
<p>å¤åˆ¶ä»£ç 
1.2 ä¸Šä¼ è¡¨å•</p>

<p>è¦åœ¨ form æ ‡ç­¾ä¸­åŠ å…¥ enctype=â€multipart/form-dataâ€ è¡¨ç¤ºè¯¥è¡¨å•è¦æäº¤æ–‡ä»¶ã€‚</p>

<form action="${pageContext.request.contextPath}/test/file-upload.do" method="post" enctype="multipart/form-data">
     <input type="file" name="file" />
     <input type="submit" value="æäº¤" />
</form>
<p>1.3 å¤„ç†æ–‡ä»¶</p>

<p>1.3.1 é€šè¿‡ MultipartFile ç±»å‹çš„å‚æ•°</p>

<p>å¤åˆ¶ä»£ç 
@RequestMapping(â€œ/file-uploadâ€)
public ModelAndView upload(@RequestParam(value = â€œfileâ€, required = false) MultipartFile file,
ã€€ã€€ã€€ã€€ã€€ã€€HttpServletRequest request, HttpSession session) {
    // æ–‡ä»¶ä¸ä¸ºç©º
    if(!file.isEmpty()) {
        // æ–‡ä»¶å­˜æ”¾è·¯å¾„
        String path = request.getServletContext().getRealPath(â€œ/â€);
        // æ–‡ä»¶åç§°
        String name = String.valueOf(new Date().getTime()+â€_â€œ+file.getOriginalFilename());
        File destFile = new File(path,name);
        // è½¬å­˜æ–‡ä»¶
        try {
            file.transferTo(destFile);
        } catch (IllegalStateException | IOException e) {
            e.printStackTrace();
        }
        // è®¿é—®çš„url
        String url = request.getScheme() + â€œ://â€ + request.getServerName() + â€œ:â€ + request.getServerPort()
ã€€ã€€ã€€ã€€ã€€ã€€+ request.getContextPath() + â€œ/â€ + name;
    }      <br />
    ModelAndView mv = new ModelAndView();
    mv.setViewName(â€œother/homeâ€);
    return mv;
}
å¤åˆ¶ä»£ç 
1.3.2 é€šè¿‡ MultipartHttpServletRequest ç±»å‹çš„å‚æ•°</p>

<p>å¤åˆ¶ä»£ç 
@RequestMapping(â€œ/file-uploadâ€)
public ModelAndView upload(MultipartHttpServletRequest request, HttpSession session) {
    // æ ¹æ®é¡µé¢inputæ ‡ç­¾çš„name
    MultipartFile file = request.getFile(â€œfileâ€);
    // æ–‡ä»¶ä¸ä¸ºç©º
    if(!file.isEmpty()) {
        // æ–‡ä»¶å­˜æ”¾è·¯å¾„
        String path = request.getServletContext().getRealPath(â€œ/â€);
        // æ–‡ä»¶åç§°
        String name = String.valueOf(new Date().getTime()+â€_â€œ+file.getOriginalFilename());
        File destFile = new File(path,name);
        // è½¬å­˜æ–‡ä»¶
        try {
            file.transferTo(destFile);
        } catch (IllegalStateException | IOException e) {
            e.printStackTrace();
        }
        // è®¿é—®çš„url
        String url = request.getScheme() + â€œ://â€ + request.getServerName() + â€œ:â€ + request.getServerPort()
ã€€ã€€ã€€ã€€ã€€ã€€+ request.getContextPath() + â€œ/â€ + name;
    }      <br />
    ModelAndView mv = new ModelAndView();
    mv.setViewName(â€œother/homeâ€);
    return mv;
}
å¤åˆ¶ä»£ç 
2 æºç åˆ†æ</p>

<p>StandardServletMultipartResolver å®ç°äº† MultipartResolver æ¥å£ï¼ŒresolveMultipart() æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼Œå…¶ä¸­ resolveLazily æ˜¯åˆ¤æ–­æ˜¯å¦è¦å»¶è¿Ÿè§£ææ–‡ä»¶ï¼ˆé€šè¿‡XMLå¯ä»¥è®¾ç½®ï¼‰ã€‚</p>

<p>å¤åˆ¶ä»£ç 
public MultipartHttpServletRequest resolveMultipart(HttpServletRequest request) throws MultipartException {
    return new StandardMultipartHttpServletRequest(request, this.resolveLazily);
}
public StandardMultipartHttpServletRequest(HttpServletRequest request, boolean lazyParsing) throws MultipartException {
    super(request);
    // åˆ¤æ–­æ˜¯å¦ç«‹å³è§£æ
    if (!lazyParsing) {
        parseRequest(request);
    }
}
å¤åˆ¶ä»£ç 
å¯¹è¯·æ±‚æ•°æ®çš„è§£æå·¥ä½œæ˜¯åœ¨ parseRequest() æ–¹æ³•ä¸­è¿›è¡Œçš„ï¼Œç»§ç»­çœ‹ä¸€ä¸‹ parseRequest() æ–¹æ³•æºç </p>

<p>å¤åˆ¶ä»£ç 
private void parseRequest(HttpServletRequest request) {
    try {
        Collection<Part> parts = request.getParts();
        this.multipartParameterNames = new LinkedHashSet<String>(parts.size());
        MultiValueMap&lt;String, MultipartFile&gt; files = new LinkedMultiValueMap&lt;String, MultipartFile&gt;(parts.size());
        for (Part part : parts) {
            String disposition = part.getHeader(CONTENT_DISPOSITION);
            String filename = extractFilename(disposition);
            if (filename == null) {
                filename = extractFilenameWithCharset(disposition);
            }
            if (filename != null) {
                files.add(part.getName(), new StandardMultipartFile(part, filename));
            } else {
                this.multipartParameterNames.add(part.getName());
            }
        }
        setMultipartFiles(files);
    } catch (Throwable ex) {}
}
å¤åˆ¶ä»£ç 
parseRequest() æ–¹æ³•åˆ©ç”¨äº† servlet3.0 çš„ request.getParts() æ–¹æ³•è·å–ä¸Šä¼ æ–‡ä»¶ï¼Œå¹¶å°†å…¶å°è£…åˆ° MultipartFile å¯¹è±¡ä¸­ã€‚</String></Part></p>
:ET